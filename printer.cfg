################################################################################
#   ___        _         _   ___             _
#  / __| __ _ | | __ _  __| | | __|__  _ _ | |__         | |
#  \__ \/ _` || |/ _` |/ _` | | _/ _ \| '_|| / /       | | |
#  |___/\__,_||_|\__,_|\__,_| |_|\___/|_|  |_\_\       \_+_/
#                                                        |
#             S A L A D   F O R K   180                  |
#
################################################################################
#
# === HARDWARE SPECIFICATIONS ===
#   Mainboard:        Bigtreetech Manta M8P V2.0
#   Toolboard:        Bigtreetech EBB36 CAN V1.2.1
#   Toolhead:         A4T
#   Probe:            Cartographer V4 (CAN Mode)
#   Extruder:         WristWatch-G2 (LDO-36STH20-1004AHG-9T 1.00A Peak)
#   Hotend:           Phaetus Rapido 2F Plus UHF
#   Motors A/B:       Moons MS14HS5P4150 (1.5A Peak)
#   Motors Z:         Moons LE174S-T0808-200-AR3-S-065 (0.65A Peak)
#   Filament Sensor:  BTT SFS V2.0
#
# ===  KEY MACRO FEATURES & SMART LOGIC ===
# - Centralized Variables: All parameters managed via a single macro block.
# - Thermal Management: Mandatory mechanical bed soak & dynamic chamber heat.
# - VOC Filtration: Auto-trigger for high-temp filaments; 10min post-run timer.
# - Heat Creep Protection: Real-time fan RPM monitoring with emergency shutdown.
# - Sensorless Homing: TMC current reduction & safe blind Z-lifts.
# - Filament Logic: Sensor auto-toggle during start/purge to avoid false trips.
# - Advanced Purge: High-performance Prime Blob sequence (RatOS inspired).
# - Idle Management: Toolhead parking, power-down & timer cancellation.
# - TMC Autotune: Optimized motor registers for silence and performance.
# - LED Status: Visual feedback based on Voron Stealthburner logic.
# - Slicer Compatibility: Integrated dummy and translation macros for Marlin
#   & RepRap commands (G27, G29, M108, etc.) to prevent console spam.
#
# ===  SLICER CONFIGURATION GUIDE ===
#
# --- ORCA SLICER & PRUSASLICER ---
# [Machine Start G-Code]
# M190 S0 ; Prevents slicer hardcoded heating
# M109 S0 ; Prevents slicer hardcoded heating
# SET_PRINT_STATS_INFO TOTAL_LAYER=[total_layer_count]
# PRINT_START BED_TEMP=[first_layer_bed_temperature] EXTRUDER_TEMP=[first_layer_temperature] CHAMBER=[chamber_temperature]
#
# [Machine End G-Code]
# PRINT_END
#
# [Before Layer Change G-Code]
# G92 E0
# {if layer_num == 2}_TOGGLE_FILAMENT_SENSORS ENABLE=1{endif} ; Enable sensor after layer 2
#
# [After Layer Change G-Code]
# SET_PRINT_STATS_INFO CURRENT_LAYER={layer_num + 1}
# SET_DISPLAY_TEXT MSG="Layer {layer_num + 1}/[total_layer_count]"
#
# --- ULTIMAKER CURA ---
# [Start G-Code]
# PRINT_START BED_TEMP={material_bed_temperature_layer_0} EXTRUDER_TEMP={material_print_temperature_layer_0} CHAMBER={build_volume_temperature}
#
# [End G-Code]
# PRINT_END
#
# [Layer Change & Sensor Toggle]
# Use Post-Processing Script: "Insert at layer change"
# 1. When: "Before" | 2. Layer: "3" | 3. G-code: "_TOGGLE_FILAMENT_SENSORS ENABLE=1"
#
# ===  REUSE & PORTING GUIDE ===
# While not explicitly generated as a template, this configuration
# can easily serve as a robust blueprint or inspiration. Because the
# macros calculate positions automatically based on your axis limits,
# porting this setup to another CoreXY printer (like a Voron 2.4,
# Trident, or Micron) or resizing the build volume requires only a
# few manual adjustments.
#
# DISCLAIMER: Use at your own risk. No warranty or guarantee is provided.
# Always verify physical limits and kinematics. I assume you know what
# you are doing.
#
# 1. MAINSAIL VARIABLES [gcode_macro _CLIENT_VARIABLE]:
#    - variable_custom_park_x: Update to the new X-axis bed center.
#    - variable_custom_park_y: Update to the new Y-axis maximum.
#
# 2. CUSTOM VARIABLES [gcode_macro _MY_VARS]:
#    - Check 'variable_blob_feedrate' and purge distances. Make sure a
#      smaller bed still provides enough physical space for the purge sequence.
#
# 3. KINEMATICS & LIMITS:
#    - [stepper_x] / [stepper_y]: Adjust 'position_max' and 'position_endstop'.
#    - Z-Steppers: Add or remove stepper definitions based on your frame
#      configuration (e.g., add 'stepper_z3' for a Voron 2.4).
#
# 4. LEVELING & RESONANCE:
#    - Kinematics: Use [z_tilt] for 3 Z-motors or [quad_gantry_level] for 4.
#    - Coordinates: Update 'z_positions' (exact physical motor/pivot points)
#      and 'points' (probe locations) to match your new bed geometry.
#    - [bed_mesh]: Set the new 'zero_reference_position', 'mesh_min', & 'mesh_max'.
#    - [resonance_tester]: Change 'probe_points' to the new bed center.
#
################################################################################

################################################################################
# Mainsail
################################################################################
[include mainsail.cfg]

[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos    : True              ; Enable custom park positions
variable_custom_park_x     : 90.0              ; Custom park position for X
variable_custom_park_y     : 170.0             ; Custom park position for Y
variable_custom_park_dz    : 50.0              ; Custom park Z hop height
variable_speed_move        : 300.0             ; Toolhead park move speed
variable_park_at_cancel    : True              ; Park toolhead on print cancel
variable_use_fw_retract    : True              ; Use firmware retraction in macros
variable_idle_timeout      : 43200             ; Set to 12h; Mainsail applies this on PAUSE and restores original value on RESUME
variable_user_pause_macro  : "_HOOK_ON_PAUSE"  ; Hook: Triggered inside PAUSE
variable_user_resume_macro : "_HOOK_ON_RESUME" ; Hook: Triggered inside RESUME
variable_user_cancel_macro : "_HOOK_ON_CANCEL" ; Hook: Triggered inside CANCEL_PRINT
gcode:
    ; Mandatory G-Code section for variable macros

################################################################################
# System Includes & Core Features
################################################################################
[exclude_object]

[force_move]
enable_force_move: True

[gcode_arcs]
resolution: 1.0

[respond]

[shaketune]
show_macros_in_webui: True

[skew_correction]

[include toolhead_leds.cfg]

################################################################################
# MCU Definitions & Kinematics
################################################################################
[mcu]
canbus_uuid: 26ba4180df89

[mcu ebb36]
canbus_uuid: 19f06894b5c0

[printer]
kinematics: corexy
max_velocity: 400
max_accel: 7500
max_z_velocity: 10
max_z_accel: 50
square_corner_velocity: 5

################################################################################
# Cartographer V4 related
################################################################################
[mcu cartographer]
canbus_uuid: d01f7feb964e

[cartographer]
mcu: cartographer
x_offset: 0
y_offset: 21.1
travel_speed: 50
verbose: false

[cartographer scan]
probe_speed: 5
mesh_runs: 1
mesh_direction: x
mesh_height: 3
mesh_path: snake

[cartographer touch]
samples: 3
max_samples: 10
sample_range: 0.01
retract_distance: 2
UNSAFE_max_touch_temperature: 150

[cartographer coil]
name: cartographer_coil
min_temp: 0
max_temp: 105

[temperature_sensor cartographer]
sensor_type: temperature_mcu
sensor_mcu: cartographer
min_temp: 5
max_temp: 105

[adxl345 cartographer]
cs_pin: cartographer:PA0
spi_bus: spi1

[axis_twist_compensation]

################################################################################
# Motion System (Steppers, TMCs, Autotune)
################################################################################
# --- X Axis (B Motor) ---
[stepper_x]
step_pin: PE2
dir_pin: PE1
enable_pin: !PE4
rotation_distance: 32
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: 0
position_max: 180
position_endstop: 180
homing_speed: 40
homing_retract_dist: 0
homing_positive_dir: True

[tmc2209 stepper_x]
uart_pin: PE3
diag_pin: ^PF3
interpolate: True
run_current: 0.90
sense_resistor: 0.110

[autotune_tmc stepper_x]
motor: moons-ms14hs5p4150
tuning_goal: performance
sg4_thrs: 200 # use highest value that will not cause a false trigger in sensorless homing
voltage: 24

# --- Y Axis (A Motor) ---
[stepper_y]
step_pin: PE6
dir_pin: PE5
enable_pin: !PC14
rotation_distance: 32
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: 0
position_max: 180
position_endstop: 180
homing_speed: 40
homing_retract_dist: 0
homing_positive_dir: True

[tmc2209 stepper_y]
uart_pin: PC13
diag_pin: ^PF4
interpolate: True
run_current: 0.90
sense_resistor: 0.110

[autotune_tmc stepper_y]
motor: moons-ms14hs5p4150
tuning_goal: performance
sg4_thrs: 200 # use highest value that will not cause a false trigger in sensorless homing
voltage: 24

# --- Z0 Axis (Front Left) ---
[stepper_z]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PE0
rotation_distance: 8
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_min: -5
position_max: 160
homing_retract_dist: 0
homing_speed: 8
second_homing_speed: 3

[tmc2209 stepper_z]
uart_pin: PB9
interpolate: True
run_current: 0.40
sense_resistor: 0.110

[autotune_tmc stepper_z]
motor: moons-le174s-t0808-200-ar3-s-065
tuning_goal: silent
voltage: 24

# --- Z1 Axis (Rear) ---
[stepper_z1]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB6
rotation_distance: 8
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PB5
interpolate: True
run_current: 0.40
sense_resistor: 0.110

[autotune_tmc stepper_z1]
motor: moons-le174s-t0808-200-ar3-s-065
tuning_goal: silent
voltage: 24

# --- Z2 Axis (Front Right) ---
[stepper_z2]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
rotation_distance: 8
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z2]
uart_pin: PG14
interpolate: True
run_current: 0.40
sense_resistor: 0.110

[autotune_tmc stepper_z2]
motor: moons-le174s-t0808-200-ar3-s-065
tuning_goal: silent
voltage: 24

################################################################################
# Extruder & Bed Heaters
################################################################################
# --- Extruder ---
[extruder]
step_pin: ebb36:PD0
dir_pin: !ebb36:PD1
enable_pin: !ebb36:PD2
rotation_distance: 47.088
gear_ratio: 9:1
microsteps: 16
full_steps_per_rotation: 200

# Filament & Nozzle
nozzle_diameter: 0.400
filament_diameter: 1.75
max_extrude_only_velocity: 60
max_extrude_only_distance: 200

# Heater
heater_pin: ebb36:PB13
min_temp: 10
max_temp: 330
max_power: 1.0
min_extrude_temp: 170

# Sensor (PT1000/MAX31865)
sensor_type: MAX31865
sensor_pin: ebb36:PA4
spi_software_sclk_pin: ebb36:PA5
spi_software_mosi_pin: ebb36:PA7
spi_software_miso_pin: ebb36:PA6
rtd_nominal_r: 1000
rtd_reference_r: 4300
rtd_num_of_wires: 2
rtd_use_50Hz_filter: True

# Control (PID)
#control: pid
#pid_kp: 34.577
#pid_ki: 12.807
#pid_kd: 23.339

# Pressure Advance
pressure_advance: 0.030
pressure_advance_smooth_time: 0.025

[tmc2209 extruder]
uart_pin: ebb36:PA15
interpolate: True
run_current: 0.60
sense_resistor: 0.110

[autotune_tmc extruder]
motor: ldo-36sth20-1004ahg-9T
tuning_goal: performance
voltage: 24

[firmware_retraction]
retract_length: 0.8
retract_speed: 60
unretract_extra_length: 0
unretract_speed: 60

# --- Bed Heater ---
[heater_bed]
heater_pin: PF5
sensor_type: Generic 3950
sensor_pin: PB1
max_power: 0.6
min_temp: 0
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769

################################################################################
# Cooling & Fans
################################################################################
# --- Part Cooling Fan ---
[fan]
pin: ebb36:PA1
max_power: 1.0
kick_start_time: 0.5
off_below: 0.10
cycle_time: 0.010

# --- Hotend Cooling Fan ---
[heater_fan hotend_fan]
pin: ebb36:PA0
tachometer_pin: ^ebb36:PB9
tachometer_ppr: 2
tachometer_poll_interval: 0.0009
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

# --- Hotend Fan Guard (Background Monitoring) ---
[delayed_gcode _FAN_GUARD]
initial_duration: 5.0
gcode:
    {% set rpm = printer['heater_fan hotend_fan'].rpm|default(0)|float %}             ; Get hotend fan RPM
    {% set actual_temp = printer.extruder.temperature|float %}                        ; Get actual extruder temperature
    {% set target_temp = printer.extruder.target|float %}                             ; Get target extruder temperature
    {% set print_state = printer.print_stats.state|default("standby")|string|lower %} ; Get current print state

    ; --- LOGIC ---
    ; 1. Monitor ALWAYS if active heating is requested (target_temp >= 50.0)
    ; 2. Cooldown & M600 set target_temp to 0,
    ;    so the guard safely ignores fan stops there
    ; 3. actual_temp >= 55.0 gives the fan a 5C window
    ;    to physically spin up after reaching trigger temp
    {% if target_temp >= 50.0 and actual_temp >= 55.0 %}
        {% if rpm < 7000 %}                                                           ; Check if RPM drops below critical threshold
            _NOTIFY MSG="Error: Hotend fan failed! Deactivating heater."
            SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0                           ; Turn off hotend heater immediately (Heat Creep protection)
            {% if print_state == "printing" %}
                PAUSE                                                                 ; Pause the print ONLY if actually printing
            {% endif %}
        {% endif %}
    {% endif %}

    ; --- LOOP ---
    UPDATE_DELAYED_GCODE ID=_FAN_GUARD DURATION=5.0                                   ; Restart the monitoring loop

# --- Electronics Fan ---
[controller_fan controller_fan]
pin: PF7
kick_start_time: 2
max_power: 0.60
heater: extruder
stepper: stepper_x, stepper_y, stepper_z

# --- Nevermore filter ---
[fan_generic nevermore]
pin: PF9
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 5.0
cycle_time: 0.01
off_below: 0.1

################################################################################
# Probing, Leveling & Resonance
################################################################################
[z_tilt]
z_positions:
    -50, -13
     90, 217
    213, -13
points:
     20, 10
     90, 155
    160, 10
speed: 150
horizontal_move_z: 15
retry_tolerance: 0.0100

[bed_mesh]
zero_reference_position: 90, 90
speed: 150
horizontal_move_z: 3
mesh_min: 25, 25
mesh_max: 155, 155
probe_count: 20, 20
adaptive_margin: 10
mesh_pps: 0, 0

[adxl345 ebb36]
cs_pin: ebb36: PB12
spi_bus: spi2_PB2_PB11_PB10
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345 cartographer
probe_points: 90, 90, 20

[input_shaper]
shaper_type_x: mzv
shaper_freq_x: 50.0
shaper_type_y: mzv
shaper_freq_y: 50.0

################################################################################
# System Sensors & Peripherals
################################################################################
# --- MCU Temperatures ---
[temperature_sensor pi]
sensor_type: temperature_host
min_temp: 5
max_temp: 100
gcode_id: pi_th

[temperature_sensor mcu]
sensor_type: temperature_mcu
min_temp: 5
max_temp: 100
gcode_id: mcu_th

[temperature_sensor mcu_ebb36]
sensor_type: temperature_mcu
sensor_mcu: ebb36
min_temp: 5
max_temp: 100
gcode_id: ebb36_th

[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PC5
min_temp: -273 # !!! Change to 0 if the sensor is connected after printer build !!!
max_temp: 100
gcode_id: chamber_th

# --- Filament Sensors (BTT SFS v2) ---
[filament_switch_sensor switch_sensor]
switch_pin: ^PF0
pause_on_runout: false
runout_gcode:
    {% if printer.print_stats.state == "printing" %}
        _NOTIFY MSG="Filament: Switch detected runout."
        M600
    {% endif %}
insert_gcode:
    _NOTIFY MSG="Filament: Switch detected insertion."

[filament_motion_sensor encoder_sensor]
switch_pin: ^PC15
detection_length: 2.88
extruder: extruder
pause_on_runout: false
runout_gcode:
    {% if printer.print_stats.state == "printing" %}
        _NOTIFY MSG="Filament: Encoder detected runout."
        M600
    {% endif %}
insert_gcode:
    _NOTIFY MSG="Filament: Encoder detected insertion."

# --- Lighting ---
[multi_pin caselight_pins]
pins: PF6, PF8

[output_pin caselight]
pin: multi_pin:caselight_pins
pwm: True
cycle_time: 0.01
value: 1.0
shutdown_value: 0.0

[neopixel toolhead_leds]
pin: ebb36:PD3
chain_count: 3
color_order: GRB

# --- Idle Timeout ---
[idle_timeout]
timeout: 3600
gcode:
    {% if printer.pause_resume.is_paused %}
        _NOTIFY MSG="System: Idle timeout during pause. Steppers ON, Heaters OFF."
        TURN_OFF_HEATERS
    {% else %}
        _NOTIFY MSG="System: Idle timeout. Steppers OFF, Heaters OFF."
        TURN_OFF_HEATERS
        M107                                                                       ; Turn off part cooling fan
        SET_FAN_SPEED FAN=nevermore SPEED=0.0                                      ; Turn off Nevermore filter
        UPDATE_DELAYED_GCODE ID=STOP_NEVERMORE DURATION=0                          ; Cancel any pending filter shutdown timer
        M84                                                                        ; Disable steppers
        _SET_LOGO_LEDS_OFF
        _STATUS_OFF                                                                ; Set LEDs to off
    {% endif %}

################################################################################
# Macro Variables
################################################################################
[gcode_macro _MY_VARS]
; --- Kinematics & Travel ---
variable_travel_factor_xy      : 0.8    ; Set travel factor for X and Y axes
variable_travel_factor_z       : 0.8    ; Set travel factor for Z axis
; --- Filament Management ---
variable_fil_load_length       : 80.0   ; Set filament load length
variable_fil_load_speed        : 600    ; Set filament load speed
variable_fil_unload_length     : 100.0  ; Set filament unload length
variable_fil_unload_speed      : 300    ; Set filament unload speed
variable_fil_purge_length      : 40.0   ; Set filament purge length
variable_fil_purge_speed       : 100    ; Set filament purge speed
variable_blob_feedrate         : 200    ; Set prime blob feedrate
; --- Temperatures & Times ---
variable_preheat_temp          : 150.0  ; Set nozzle preheat temperature
variable_bed_default_temp      : 60.0   ; Set default bed temperature fallback
variable_ext_default_temp      : 200.0  ; Set default extruder temperature fallback
variable_fil_default_temp      : 220.0  ; Set default temperature for filament handling
variable_chamber_fallback_temp : 45.0   ; Target chamber temp if bed is hot and no slicer param
variable_chamber_fallback_bed  : 90.0   ; Bed temp threshold to trigger chamber fallback
variable_filter_start_temp     : 90.0   ; Minimum bed temp to trigger VOC filtration (e.g., for ABS/ASA)
variable_base_soak_time        : 120000 ; Set base thermal soak time for mechanical stabilization (ms)
; --- Homing & Kinematics ---
variable_home_current          : 0.50   ; Set sensorless homing current
; --- Z-Heights ---
variable_z_hop                 : 10.0   ; Set default Z hop height
variable_z_soak                : 15.0   ; Set Z height for thermal soak
variable_z_purge               : 10.0   ; Set Z height for purging
gcode:
    ; Mandatory G-Code section for variable macros

################################################################################
# Homing & Leveling Macros
################################################################################
[gcode_macro CONDITIONAL_HOME]
description: Homing only if necessary
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        _NOTIFY MSG="System: Axes not homed. Executing G28..."
        G28
    {% else %}
        _NOTIFY MSG="System: Axes already homed. Skipping G28."
    {% endif %}

[gcode_macro _HOME_AXIS]
description: Helper for sensorless homing
gcode:
    {% set axis = params.AXIS|string|lower %}                                   ; Get axis parameter for homing
    {% set run_current_x = printer['tmc2209 stepper_x'].run_current|float %}    ; Get current run current for X axis
    {% set run_current_y = printer['tmc2209 stepper_y'].run_current|float %}    ; Get current run current for Y axis
    {% set home_current = printer["gcode_macro _MY_VARS"].home_current|float %} ; Get homing current from variables

    _NOTIFY MSG="System: Homing {axis|upper}..."
    SAVE_GCODE_STATE NAME=STATE_HOME_AXIS                                       ; Save gcode state
    M400                                                                        ; Wait for moves
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={home_current}                    ; Set homing current X
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={home_current}                    ; Set homing current Y
    G4 P500                                                                     ; Wait for StallGuard stability

    G28 {axis|upper}                                                            ; Execute homing
    G91                                                                         ; Set relative positioning
    G0 {axis|upper}-10 F1200                                                    ; Move away from rail
    G90                                                                         ; Set absolute positioning
    G4 P500                                                                     ; Wait for StallGuard clear

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={run_current_x}                   ; Restore current X
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={run_current_y}                   ; Restore current Y
    RESTORE_GCODE_STATE NAME=STATE_HOME_AXIS                                    ; Restore gcode state

[homing_override]
axes: xyz
gcode:
    {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}  ; Check if all axes require homing
    {% set home_x = home_all or 'X' in params %}                                        ; Check if X axis requires homing
    {% set home_y = home_all or 'Y' in params %}                                        ; Check if Y axis requires homing
    {% set home_z = home_all or 'Z' in params %}                                        ; Check if Z axis requires homing
    {% set th = printer.toolhead %}                                                     ; Get toolhead properties
    {% set homed = th.homed_axes %}                                                     ; Get currently homed axes
    {% set travel_factor_xy = printer["gcode_macro _MY_VARS"].travel_factor_xy|float %} ; Get XY travel factor from variables
    {% set travel_factor_z = printer["gcode_macro _MY_VARS"].travel_factor_z|float %}   ; Get Z travel factor from variables
    {% set z_hop = printer["gcode_macro _MY_VARS"].z_hop|float %}                       ; Get Z hop height from variables
    {% set feedrate_xy = (th.max_velocity * travel_factor_xy * 60)|int %}               ; Calculate XY travel feedrate
    {% set feedrate_z = (printer.configfile.settings.printer.max_z_velocity|float * travel_factor_z * 60)|int %} ; Calculate Z travel feedrate
    {% set center_x = th.axis_maximum.x|float / 2.0 %}                                  ; Calculate center position for X
    {% set center_y = th.axis_maximum.y|float / 2.0 %}                                  ; Calculate center position for Y
    {% set z_safe = [th.position.z + z_hop, th.axis_maximum.z]|min %}                   ; Calculate safe Z lift height

    _STATUS_HOMING                                                                      ; Set LEDs to homing
    G90                                                                                 ; Set absolute positioning strictly once

    ; --- Safe Z-Hop Logic to protect Bed ---
    {% if "z" in homed %}
        G0 Z{z_safe} F{feedrate_z}                                                      ; Z-hop
    {% endif %}

    {% if home_x %}
        _HOME_AXIS AXIS=X                                                               ; Home X axis
    {% endif %}

    {% if home_y %}
        _HOME_AXIS AXIS=Y                                                               ; Home Y axis
    {% endif %}

    {% if home_z %}
        {% if ("x" not in homed and not home_x) or ("y" not in homed and not home_y) %}
            _HOME_AXIS AXIS=X                                                           ; Force home X
            _HOME_AXIS AXIS=Y                                                           ; Force home Y
        {% endif %}
        G0 X{center_x} Y{center_y} F{feedrate_xy}                                       ; Move to center
        G28 Z                                                                           ; Home Z axis
        G0 Z{z_hop} F{feedrate_z}                                                       ; Z-Hop
    {% endif %}

    M400                                                                                ; Wait for moves
    _STATUS_READY                                                                       ; Set LEDs to ready

[gcode_macro Z_TILT_ADJUST]
rename_existing: _MY_Z_TILT_ADJUST
gcode:
    _STATUS_LEVELING                           ; Set LEDs to leveling
    _NOTIFY MSG="Process: Adjusting Z-tilt..."
    _MY_Z_TILT_ADJUST {rawparams}              ; Execute native command
    _STATUS_READY                              ; Set LEDs to ready

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _MY_BED_MESH_CALIBRATE
gcode:
    _STATUS_MESHING                               ; Set LEDs to meshing
    _NOTIFY MSG="Process: Generating bed mesh..."
    _MY_BED_MESH_CALIBRATE {rawparams}            ; Execute native command
    _STATUS_READY                                 ; Set LEDs to ready

################################################################################
# Print Lifecycle Macros
################################################################################
[gcode_macro PRINT_START]
description: Main startup procedure
gcode:
    {% set default_bed = printer["gcode_macro _MY_VARS"].bed_default_temp|float %}           ; Get default bed temp from variables
    {% set default_ext = printer["gcode_macro _MY_VARS"].ext_default_temp|float %}           ; Get default extruder temp from variables
    {% set fallback_chamber = printer["gcode_macro _MY_VARS"].chamber_fallback_temp|float %} ; Get default chamber temp from variables
    {% set fallback_bed = printer["gcode_macro _MY_VARS"].chamber_fallback_bed|float %}      ; Get bed threshold for chamber fallback
    {% set target_bed = params.BED_TEMP|default(default_bed)|float %}                        ; Get target bed temperature parameter
    {% set target_extruder = params.EXTRUDER_TEMP|default(default_ext)|float %}              ; Get target extruder temperature parameter
    {% set raw_chamber = params.CHAMBER|default(0.0)|float %}                                ; Read chamber param from slicer (usually 0.0 if not set)
    {% set target_chamber = fallback_chamber if (raw_chamber == 0.0 and target_bed >= fallback_bed) else raw_chamber %} ; Set chamber to fallback temp if bed is >= threshold and slicer sent 0.0
    {% set filter_start_temp = printer["gcode_macro _MY_VARS"].filter_start_temp|float %}    ; Set filter start temp for technical filaments
    {% set th = printer.toolhead %}                                                          ; Get toolhead properties
    {% set travel_factor_xy = printer["gcode_macro _MY_VARS"].travel_factor_xy|float %}      ; Get XY travel factor from variables
    {% set travel_factor_z = printer["gcode_macro _MY_VARS"].travel_factor_z|float %}        ; Get Z travel factor from variables
    {% set z_soak = printer["gcode_macro _MY_VARS"].z_soak|float %}                          ; Get Z soak height from variables
    {% set z_purge = printer["gcode_macro _MY_VARS"].z_purge|float %}                        ; Get Z purge height from variables
    {% set preheat_temp = printer["gcode_macro _MY_VARS"].preheat_temp|float %}              ; Get preheat temperature from variables
    {% set base_soak_time = printer["gcode_macro _MY_VARS"].base_soak_time|int %}            ; Get base thermal soak time from variables
    {% set base_soak_min = (base_soak_time / 60000)|int %}                                   ; Calculate base soak time in minutes
    {% set feedrate_xy = (th.max_velocity * travel_factor_xy * 60)|int %}                    ; Calculate XY travel feedrate
    {% set feedrate_z = (printer.configfile.settings.printer.max_z_velocity|float * travel_factor_z * 60)|int %} ; Calculate Z travel feedrate
    {% set center_x = th.axis_maximum.x|float / 2.0 %}                                       ; Calculate center position for X
    {% set center_y = th.axis_maximum.y|float / 2.0 %}                                       ; Calculate center position for Y
    {% set purge_x = th.axis_minimum.x|float + 5.0 %}                                        ; Calculate purge position for X
    {% set purge_y = th.axis_minimum.y|float + 5.0 %}                                        ; Calculate purge position for Y

    ; --- INITIALIZATION ---
    _STATUS_BUSY                                                                        ; Set LEDs to busy
    UPDATE_DELAYED_GCODE ID=STOP_NEVERMORE DURATION=0                                   ; Cancel any pending filter shutdown timer
    G21                                                                                 ; Set metric system
    G90                                                                                 ; Set absolute positioning
    M83                                                                                 ; Set relative extruder
    _RESET_STATE                                                                        ; Clear all transformations

    ; --- HEATING & HOMING ---
    _NOTIFY MSG="Process: Heating bed to {target_bed}C..."
    _STATUS_HEATING                                                                     ; Set LEDs to heating
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={target_bed}                        ; Heat bed (non-blocking)
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={preheat_temp}                        ; Preheat nozzle (non-blocking)
    CONDITIONAL_HOME                                                                    ; Execute conditional homing

    ; --- FILTER LOGIC ---
    {% if target_bed >= filter_start_temp %}                                            ; Check if target bed temp requires VOC filtration
        _NOTIFY MSG="Process: Enabling Nevermore VOC filter."
        SET_FAN_SPEED FAN=nevermore SPEED=1.0                                           ; Enable internal filter
    {% endif %}

    ; --- THERMAL SOAKING & STABILIZATION ---
    _STATUS_HEATING                                                                     ; Set LEDs to heating
    _NOTIFY MSG="Process: Thermal soaking..."
    G0 Z{z_soak} F{feedrate_z}                                                          ; Move to soak height safely
    G0 X{center_x} Y{center_y} F{feedrate_xy}                                           ; Move to bed center
    M190 S{target_bed}                                                                  ; Wait for bed temp to settle

    ; Mandatory Base Soak (Allows physical bed expansion to settle before meshing)
    _NOTIFY MSG="Process: Mandatory Bed Soak ({base_soak_min}min) for mechanical stabilization..."
    G4 P{base_soak_time}                                                                ; Execute base thermal soak

    ; Optional Chamber Heating (Only executed if a target > 0.0 is calculated)
    {% if target_chamber > 0.0 %}
        _NOTIFY MSG="Process: Waiting for chamber to reach {target_chamber}C..."
        TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber}   ; Block until chamber temp is reached
    {% endif %}

    ; --- CALIBRATION ---
    Z_TILT_ADJUST                                                                       ; Execute mechanical leveling
    CARTOGRAPHER_TOUCH_HOME                                                             ; Cartographer touch home for real Z0, change to G28 Z if you do not use a Cartographer
    BED_MESH_CALIBRATE ADAPTIVE=1                                                       ; Generate bed mesh

    ; --- PURGE ---
    _NOTIFY MSG="Process: Heating nozzle to {target_extruder}C..."
    _STATUS_HEATING                                                                     ; Set LEDs to heating
    G0 X{purge_x} Y{purge_y} F{feedrate_xy}                                             ; Move to purge XY position
    G0 Z{z_purge} F{feedrate_z}                                                         ; Lower to purge height
    M109 S{target_extruder}                                                             ; Heat nozzle and wait for temperature to settle
    PRIME_BLOB                                                                          ; Execute priming

    ; --- START ---
    _TOGGLE_FILAMENT_SENSORS ENABLE=0                                                   ; INTENTIONALLY DISABLE THE FILAMENT SENSORS (they will be enabled by the slicer after layer 2)
    _STATUS_PRINTING                                                                    ; Set LEDs to printing
    _NOTIFY MSG="Process: Print job started."

[gcode_macro PRINT_END]
description: Finalize print job
gcode:
    {% set nevermore_speed = printer['fan_generic nevermore'].speed | default(0.0) %}   ; Get fan speed of filter

    M400                                                                                ; Wait for moves
    G10                                                                                 ; Firmware retraction
    TURN_OFF_HEATERS                                                                    ; Turn off heaters early
    M107                                                                                ; Turn off part cooling fan
    _PARK_TOOLHEAD                                                                      ; Execute parking routine with default Z hop
    M84                                                                                 ; Disable steppers
    _TOGGLE_FILAMENT_SENSORS ENABLE=1                                                   ; Enable runout sensors
    _RESET_STATE                                                                        ; Clear all transformations
    _STATUS_READY                                                                       ; Set LEDs to ready

    ; --- CHAMBER FILTERING & COOLDOWN ---
    {% if nevermore_speed > 0.0 %}
        _NOTIFY MSG="Process: Print finished. Filtering VOCs for 10 min."
        UPDATE_DELAYED_GCODE ID=STOP_NEVERMORE DURATION=600                             ; Schedule Nevermore shutdown
    {% else %}
        _NOTIFY MSG="Process: Print finished."
    {% endif %}

[delayed_gcode STOP_NEVERMORE]
gcode:
    SET_FAN_SPEED FAN=nevermore SPEED=0.0                                               ; Disable Nevermore filter
    _NOTIFY MSG="System: Filter stopped."

[gcode_macro PRIME_BLOB]
description: Purge nozzle via prime blob
gcode:
    {% set th = printer.toolhead %}                                                     ; Get toolhead properties
    {% set travel_factor_xy = printer["gcode_macro _MY_VARS"].travel_factor_xy|float %} ; Get XY travel factor from variables
    {% set blob_feedrate = printer["gcode_macro _MY_VARS"].blob_feedrate|int %}         ; Get prime blob feedrate from variables
    {% set feedrate_xy = (th.max_velocity * travel_factor_xy * 60)|int %}               ; Calculate XY travel feedrate
    {% set feedrate_fast = (th.max_velocity * 60)|int %}                                ; Calculate breakaway speed
    {% set max_y = th.axis_maximum.y|float %}                                           ; Calculate maximum Y axis position
    {% set purge_x = th.axis_minimum.x|float + 5.0 %}                                   ; Calculate purge position for X
    {% set purge_y = th.axis_minimum.y|float + 5.0 %}                                   ; Calculate purge position for Y
    {% set wipe_y1 = [purge_y + 15.0, max_y]|min %}                                     ; Calculate wipe Y position 1
    {% set wipe_y2 = [purge_y + 20.0, max_y]|min %}                                     ; Calculate wipe Y position 2
    {% set wipe_y3 = [purge_y + 25.0, max_y]|min %}                                     ; Calculate wipe Y position 3
    {% set wipe_y4 = [purge_y + 30.0, max_y]|min %}                                     ; Calculate wipe Y position 4
    {% set wipe_y5 = [purge_y + 35.0, max_y]|min %}                                     ; Calculate wipe Y position 5
    {% set wipe_yf = [purge_y + 40.0, max_y]|min %}                                     ; Calculate final wipe Y position
    {% set breakaway_y = [purge_y + 90.0, max_y]|min %}                                 ; Calculate breakaway Y position

    _STATUS_CLEANING                                                                    ; Set LEDs to cleaning
    _NOTIFY MSG="Process: Priming nozzle..."
    _TOGGLE_FILAMENT_SENSORS ENABLE=0                                                   ; Disable runout sensors
    SAVE_GCODE_STATE NAME=STATE_PRIME_BLOB                                              ; Save gcode state
    G90                                                                                 ; Set absolute positioning
    M83                                                                                 ; Set relative extruder
    G0 X{purge_x} Y{purge_y} Z0.5 F{feedrate_xy}                                        ; Move to start
    G1 F60 E20                                                                          ; Extrude slow blob
    M106 S102                                                                           ; Fan to 40%
    G1 Z5 F100 E5                                                                       ; Lift and extrude
    G1 F{blob_feedrate} Y{wipe_y1} E1                                                   ; Wipe 1
    G1 F{blob_feedrate} Y{wipe_y2} Z3.8 E0.5                                            ; Wipe 2
    G1 F{blob_feedrate} Y{wipe_y3} Z2.6 E0.5                                            ; Wipe 3
    G1 F{blob_feedrate} Y{wipe_y4} Z1.4 E0.5                                            ; Wipe 4
    G1 F{blob_feedrate} Y{wipe_y5} Z0.2 E0.5                                            ; Wipe 5
    M107                                                                                ; Turn off part cooling fan
    G1 F{blob_feedrate} Y{wipe_yf} Z0.2 E0.6                                            ; Final linear wipe
    G0 Y{breakaway_y} F{feedrate_fast}                                                  ; Fast breakaway
    M400                                                                                ; Wait for moves
    RESTORE_GCODE_STATE NAME=STATE_PRIME_BLOB                                           ; Restore gcode state
    _TOGGLE_FILAMENT_SENSORS ENABLE=1                                                   ; Enable runout sensors
    _STATUS_READY                                                                       ; Set LEDs to ready

################################################################################
# Filament Management Macros
################################################################################
[gcode_macro LOAD_FILAMENT]
description: Load filament
gcode:
    {% set default_temp = printer["gcode_macro _MY_VARS"].fil_default_temp|float %}  ; Get default temperature from variables
    {% set req_temp = params.TEMP|default(default_temp)|float %}                     ; Get requested temperature parameter
    {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|float %} ; Get minimum extrusion temperature
    {% set load_length = printer["gcode_macro _MY_VARS"].fil_load_length|float %}    ; Get filament load length from variables
    {% set load_speed = printer["gcode_macro _MY_VARS"].fil_load_speed|int %}        ; Get filament load speed from variables
    {% set purge_length = printer["gcode_macro _MY_VARS"].fil_purge_length|float %}  ; Get filament purge length from variables
    {% set purge_speed = printer["gcode_macro _MY_VARS"].fil_purge_speed|int %}      ; Get filament purge speed from variables
    {% set target_temp = req_temp|int if req_temp >= min_temp else default_temp %}   ; Calculate safe target temperature

    _STATUS_HEATING                                                                  ; Set LEDs to heating
    _NOTIFY MSG="Filament: Heating hotend to {target_temp}C for loading..."
    M109 S{target_temp}                                                              ; Heat nozzle and wait for temperature to settle
    _STATUS_BUSY                                                                     ; Set LEDs to busy
    _TOGGLE_FILAMENT_SENSORS ENABLE=0                                                ; Disable runout sensors
    SAVE_GCODE_STATE NAME=STATE_LOAD_FILAMENT                                        ; Save gcode state
    M83                                                                              ; Set relative extruder
    _NOTIFY MSG="Filament: Loading {load_length}mm..."
    G1 E{load_length} F{load_speed}                                                  ; Initial feed
    G4 P1000                                                                         ; Stabilize
    _NOTIFY MSG="Filament: Purging {purge_length}mm..."
    G1 E{purge_length} F{purge_speed}                                                ; Purge
    G10                                                                              ; Retract
    M400                                                                             ; Wait for moves
    RESTORE_GCODE_STATE NAME=STATE_LOAD_FILAMENT                                     ; Restore gcode state
    _TOGGLE_FILAMENT_SENSORS ENABLE=1                                                ; Enable runout sensors
    _STATUS_READY                                                                    ; Set LEDs to ready
    _NOTIFY MSG="Filament: Load complete."

[gcode_macro UNLOAD_FILAMENT]
description: Eject filament
gcode:
    {% set default_temp = printer["gcode_macro _MY_VARS"].fil_default_temp|float %}   ; Get default temperature from variables
    {% set req_temp = params.TEMP|default(default_temp)|float %}                      ; Get requested temperature parameter
    {% set min_temp = printer.configfile.settings.extruder.min_extrude_temp|float %}  ; Get minimum extrusion temperature
    {% set unload_length = printer["gcode_macro _MY_VARS"].fil_unload_length|float %} ; Get filament unload length from variables
    {% set unload_speed = printer["gcode_macro _MY_VARS"].fil_unload_speed|int %}     ; Get filament unload speed from variables
    {% set target_temp = req_temp|int if req_temp >= min_temp else default_temp %}    ; Calculate safe target temperature

    _STATUS_HEATING                                                                   ; Set LEDs to heating
    _NOTIFY MSG="Filament: Heating hotend to {target_temp}C for unloading..."
    M109 S{target_temp}                                                               ; Heat nozzle and wait for temperature to settle
    _STATUS_BUSY                                                                      ; Set LEDs to busy
    _TOGGLE_FILAMENT_SENSORS ENABLE=0                                                 ; Disable runout sensors
    SAVE_GCODE_STATE NAME=STATE_UNLOAD_FILAMENT                                       ; Save gcode state
    M83                                                                               ; Set relative extruder
    _NOTIFY MSG="Filament: Unloading {unload_length}mm..."
    G1 E15 F300                                                                       ; Prime purge
    G1 E-20 F3000                                                                     ; Rapid pull
    G1 E-{unload_length} F{unload_speed}                                              ; Final ejection
    M400                                                                              ; Wait for moves
    RESTORE_GCODE_STATE NAME=STATE_UNLOAD_FILAMENT                                    ; Restore gcode state
    _TOGGLE_FILAMENT_SENSORS ENABLE=1                                                 ; Enable runout sensors
    _STATUS_READY                                                                     ; Set LEDs to ready
    _NOTIFY MSG="Filament: Unload complete."

[gcode_macro M600]
description: Filament change
gcode:
    {% set print_temp = printer.extruder.target|int %}                ; Get current extruder target temperature

    PAUSE                                                             ; Pause print (Mainsail handles state and timeout natively)
    _STATUS_BUSY                                                      ; Set LEDs to busy
    UNLOAD_FILAMENT TEMP={print_temp}                                 ; Eject filament
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0                   ; Extruder off (Mainsail RESUME will automatically reheat)
    _STATUS_BUSY                                                      ; Set LEDs to busy
    _NOTIFY MSG="Action: Change filament or clear runout and resume."

################################################################################
# Parking & Movement Macros
################################################################################
[gcode_macro _PARK_TOOLHEAD]
description: Helper macro for safe toolhead parking
gcode:
    {% set default_dz = printer["gcode_macro _CLIENT_VARIABLE"].custom_park_dz|float %}   ; Get default Z hop height
    {% set dz = params.Z_HOP|default(default_dz)|float %}                                 ; Get override of Z hop height
    {% set th = printer.toolhead %}                                                       ; Get toolhead properties
    {% set custom_park_x = printer["gcode_macro _CLIENT_VARIABLE"].custom_park_x|float %} ; Get custom park position for X
    {% set custom_park_y = printer["gcode_macro _CLIENT_VARIABLE"].custom_park_y|float %} ; Get custom park position for Y
    {% set travel_factor_xy = printer["gcode_macro _MY_VARS"].travel_factor_xy|float %}   ; Get XY travel factor from variables
    {% set travel_factor_z = printer["gcode_macro _MY_VARS"].travel_factor_z|float %}     ; Get Z travel factor from variables
    {% set feedrate_xy = (th.max_velocity * travel_factor_xy * 60)|int %}                 ; Calculate XY travel feedrate
    {% set feedrate_z = (printer.configfile.settings.printer.max_z_velocity|float * travel_factor_z * 60)|int %} ; Calculate Z travel feedrate
    {% set park_z = [th.position.z + dz, th.axis_maximum.z]|min %}                        ; Calculate safe park Z height
    {% set park_x = [custom_park_x, th.axis_maximum.x]|min %}                             ; Calculate safe park X position
    {% set park_y = [custom_park_y, th.axis_maximum.y]|min %}                             ; Calculate safe park Y position

    SAVE_GCODE_STATE NAME=STATE_PARK_TOOLHEAD                                             ; Save gcode state
    G90                                                                                   ; Set absolute positioning
    G0 Z{park_z} F{feedrate_z}                                                            ; Lift toolhead strictly vertically first
    G0 X{park_x} Y{park_y} F{feedrate_xy}                                                 ; Move toolhead to park XY
    M400                                                                                  ; Wait for moves
    RESTORE_GCODE_STATE NAME=STATE_PARK_TOOLHEAD

[gcode_macro CENTER]
description: Move toolhead to center
gcode:
    {% set th = printer.toolhead %}                                                     ; Get toolhead properties
    {% set actual_z = th.position.z|float %}                                            ; Get actual Z position
    {% set travel_factor_xy = printer["gcode_macro _MY_VARS"].travel_factor_xy|float %} ; Get XY travel factor from variables
    {% set travel_factor_z = printer["gcode_macro _MY_VARS"].travel_factor_z|float %}   ; Get Z travel factor from variables
    {% set feedrate_xy = (th.max_velocity * travel_factor_xy * 60)|int %}               ; Calculate XY travel feedrate
    {% set feedrate_z = (printer.configfile.settings.printer.max_z_velocity|float * travel_factor_z * 60)|int %} ; Calculate Z travel feedrate
    {% set center_x = th.axis_maximum.x|float / 2.0 %}                                  ; Calculate center position for X
    {% set center_y = th.axis_maximum.y|float / 2.0 %}                                  ; Calculate center position for Y
    {% set center_z = th.axis_maximum.z|float / 2.0 %}                                  ; Calculate center position for Z

    _STATUS_BUSY                                                                        ; Set LEDs to busy
    _NOTIFY MSG="System: Moving toolhead to center..."
    SAVE_GCODE_STATE NAME=STATE_CENTER                                                  ; Save gcode state
    G90                                                                                 ; Set absolute positioning
    {% if actual_z < center_z %}
        G0 Z{center_z} F{feedrate_z}                                                    ; Lift Z if below center
    {% endif %}
    G0 X{center_x} Y{center_y} F{feedrate_xy}                                           ; Move to XY center
    M400                                                                                ; Wait for moves
    RESTORE_GCODE_STATE NAME=STATE_CENTER                                               ; Restore gcode state
    _STATUS_READY                                                                       ; Set LEDs to ready

################################################################################
# Slicer Compatibility Macros (Marlin / RepRap)
################################################################################
[gcode_macro G27]
description: Park Toolhead (Marlin compatibility)
gcode:
    _PARK_TOOLHEAD

[gcode_macro G29]
description: Bed mesh (RepRap compatibility)
gcode:
    BED_MESH_CALIBRATE ; Generate bed mesh

[gcode_macro G32]
description: Home and Bed leveling (RepRap compatibility)
gcode:
    CONDITIONAL_HOME ; Execute conditional homing
    Z_TILT_ADJUST    ; Execute mechanical leveling
    CARTOGRAPHER_TOUCH_HOME                        ; Cartographer touch home for real Z0, change to G28 Z if you do not use a Cartographer

[gcode_macro M108]
description: Cancel Heating (Marlin compatibility dummy)
gcode:
    _NOTIFY MSG="System: Command M108 (Cancel Heating) ignored." ; Prevent "Unknown command" console errors

[gcode_macro M116]
description: Wait for all temperatures (RepRap compatibility dummy)
gcode:
    ; Dummy macro to prevent console spam from RepRap slicers.
    ; Temperatures are managed via M109/M190 in the start sequence.

[gcode_macro M201]
description: Set Max Acceleration with safety limits (Marlin compatibility)
gcode:
    {% if 'X' in params or 'Y' in params %}
        {% set max_accel = printer.toolhead.max_accel|float %} ; Get absolute maximum acceleration
        {% set req_accel = params.X|default(params.Y)|float %} ; Get requested acceleration parameter
        {% set safe_accel = [req_accel, max_accel]|min %}      ; Calculate safe acceleration limit
        SET_VELOCITY_LIMIT ACCEL={safe_accel}                  ; Apply validated acceleration limit
    {% endif %}

[gcode_macro M203]
description: Set Max Feedrate with safety limits (Marlin compatibility)
gcode:
    {% if 'X' in params or 'Y' in params %}
        {% set max_vel = printer.toolhead.max_velocity|float %} ; Get absolute maximum velocity
        {% set req_vel = params.X|default(params.Y)|float %}    ; Get requested velocity parameter
        {% set safe_vel = [req_vel, max_vel]|min %}             ; Calculate safe velocity limit
        SET_VELOCITY_LIMIT VELOCITY={safe_vel}                  ; Apply validated velocity limit
    {% endif %}

[gcode_macro M205]
description: Set Jerk with safety limits (Marlin compatibility)
gcode:
    {% if 'X' in params or 'Y' in params %}
        {% set max_jerk = printer.toolhead.square_corner_velocity|float %} ; Get absolute maximum jerk
        {% set req_jerk = params.X|default(params.Y)|float %}              ; Get requested jerk parameter
        {% set safe_jerk = [req_jerk, max_jerk]|min %}                     ; Calculate safe jerk limit
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={safe_jerk}              ; Apply validated jerk limit
    {% endif %}

[gcode_macro M300]
description: Play Tone (Marlin compatibility dummy)
gcode:
    {% set S = params.S|default(1000)|int %}                         ; Get frequency parameter
    {% set P = params.P|default(100)|int %}                          ; Get duration parameter
    ; Trigger an [output_pin beeper] here if hardware is added later

[gcode_macro M572]
description: Set Pressure Advance (RepRap compatibility)
gcode:
    {% if 'S' in params %}
        {% set pa = params.S|float %}     ; Get S parameter for pressure advance
        SET_PRESSURE_ADVANCE ADVANCE={pa} ; Apply Pressure Advance
    {% endif %}

[gcode_macro M601]
description: Pause for PrusaSlicer/Marlin compatibility
gcode:
    PAUSE ; Trigger the standard Mainsail/Klipper pause state

[gcode_macro M701]
description: Load filament (Marlin compatibility)
gcode:
    {% if 'S' in params %}
        LOAD_FILAMENT TEMP={params.S}
    {% elif 'T' in params %}
        LOAD_FILAMENT TEMP={params.T}
    {% else %}
        LOAD_FILAMENT
    {% endif %}

[gcode_macro M702]
description: Unload filament (Marlin compatibility)
gcode:
    {% if 'S' in params %}
        UNLOAD_FILAMENT TEMP={params.S}
    {% elif 'T' in params %}
        UNLOAD_FILAMENT TEMP={params.T}
    {% else %}
        UNLOAD_FILAMENT
    {% endif %}

[gcode_macro M900]
description: Set Pressure Advance (Marlin compatibility)
gcode:
    {% if 'K' in params %}
        {% set pa = params.K|float %}     ; Get K parameter for pressure advance
        SET_PRESSURE_ADVANCE ADVANCE={pa} ; Apply Pressure Advance
    {% endif %}

################################################################################
# Core Helper Macros
################################################################################
[gcode_macro _NOTIFY]
description: Helper macro for consistent message output
gcode:
    {% set msg = params.MSG %}   ; Get message parameter

    SET_DISPLAY_TEXT MSG="{msg}" ; Output to display
    RESPOND MSG="{msg}"          ; Output to console

[gcode_macro _RESET_STATE]
description: Clears all transformations and machine states
gcode:
    M220 S100            ; Reset feedrate to 100%
    M221 S100            ; Reset flowrate to 100%
    BED_MESH_CLEAR       ; Clear active bed mesh
    CLEAR_PAUSE          ; Clear any active pause state
    SET_SKEW CLEAR=1     ; Clear skew correction profiles
    SET_GCODE_OFFSET Z=0 ; Cartographer touch strictly requires offset 0, remove this if you do not use a Cartographer

[gcode_macro _TOGGLE_FILAMENT_SENSORS]
description: Helper macro to globally toggle filament sensors
gcode:
    {% set state = params.ENABLE|default(1)|int %}           ; Get enable state parameter

    SET_FILAMENT_SENSOR SENSOR=switch_sensor ENABLE={state}  ; Toggle switch sensor
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE={state} ; Toggle encoder sensor

################################################################################
# Event Hooks (Mainsail)
################################################################################
[gcode_macro _HOOK_ON_PAUSE]
description: Hook executed when print is paused
gcode:
    _STATUS_BUSY                        ; Set LEDs to busy
    _NOTIFY MSG="System: Print paused."

[gcode_macro _HOOK_ON_RESUME]
description: Hook executed when print is resumed
gcode:
    _STATUS_PRINTING                     ; Set LEDs to printing
    _NOTIFY MSG="System: Print resumed."

[gcode_macro _HOOK_ON_CANCEL]
description: Hook executed when print is canceled
gcode:
    {% set nevermore_speed = printer['fan_generic nevermore'].speed | default(0.0) %} ; Get fan speed of filter

    _STATUS_READY                         ; Set LEDs to ready
    _TOGGLE_FILAMENT_SENSORS ENABLE=1     ; Enable runout sensors

    {% if nevermore_speed > 0.0 %}
        _NOTIFY MSG="System: Print canceled. Filtering VOCs for 10 min."
        UPDATE_DELAYED_GCODE ID=STOP_NEVERMORE DURATION=600                           ; Schedule Nevermore shutdown
    {% else %}
        _NOTIFY MSG="System: Print canceled."
    {% endif %}

################################################################################
# SAVE CONFIG Block
################################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 34.577
#*# pid_ki = 12.807
#*# pid_kd = 23.339
