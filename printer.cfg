################################################################################
#   ___   _   _      _   ___     ___ ___  ___ _  __   _  ___  ___
#  / __| /_\ | |    /_\ |   \   | __/ _ \| _ \ |/ /  / |( _ )/ _ \
#  \__ \/ _ \| |__ / _ \| |) |  | _| (_) |   / ' <   | |/ _ \ (_) |
#  |___/_/ \_\____/_/ \_\___/   |_| \___/|_|_\_|\_\  |_|\___/\___/
#
################################################################################
#
# === HARDWARE SPECIFICATIONS ===
#   Mainboard:        Bigtreetech Manta M8P V2.0
#   Toolboard:        Bigtreetech EBB36 CAN V1.2.1
#   Toolhead:         A4T
#   Probe:            Cartographer V4 (CAN Mode)
#   Extruder:         WristWatch-G2 (LDO-36STH20-1004AHG-9T 1.00A Peak)
#   Hotend:           Phaetus Rapido 2F Plus UHF
#   Motors A/B:       Moons MS14HS5P4150 (1.5A Peak)
#   Motors Z:         Moons LE174S-T0808-200-AR3-S-065 (0.65A Peak)
#   Filament Sensor:  BTT SFS V2.0
#
#   Documentation: https://github.com/Stuhl-im-Orbit/Salad-Fork
#
################################################################################

################################################################################
# Mainsail
################################################################################
[include mainsail.cfg]

[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos    : True              ; Enable custom park positions
variable_custom_park_x     : 90.0              ; Custom park position for X
variable_custom_park_y     : 170.0             ; Custom park position for Y
variable_custom_park_dz    : 15.0              ; Custom park Z hop height
variable_speed_move        : 300.0             ; Toolhead park move speed
variable_park_at_cancel    : True              ; Park toolhead on print cancel
variable_use_fw_retract    : True              ; Use firmware retraction in macros
variable_idle_timeout      : 43200             ; Set to 12h; Mainsail applies this on PAUSE and restores original value on RESUME
variable_user_pause_macro  : "_HOOK_ON_PAUSE"  ; Hook: Triggered inside PAUSE
variable_user_resume_macro : "_HOOK_ON_RESUME" ; Hook: Triggered inside RESUME
variable_user_cancel_macro : "_HOOK_ON_CANCEL" ; Hook: Triggered inside CANCEL_PRINT
gcode:
    ; Mandatory G-Code section for variable macros

################################################################################
# System Includes & Core Features
################################################################################
[exclude_object]

[force_move]
enable_force_move: True

[gcode_arcs]
resolution: 1.0

[respond]

[shaketune]
show_macros_in_webui: True

[skew_correction]

[include toolhead_leds.cfg]

################################################################################
# MCU Definitions & Kinematics
################################################################################
[mcu]
canbus_uuid: 26ba4180df89

[mcu ebb36]
canbus_uuid: 19f06894b5c0

[printer]
kinematics: corexy
max_velocity: 400
max_accel: 7500
max_z_velocity: 10
max_z_accel: 50
square_corner_velocity: 5

################################################################################
# Cartographer V4 related
################################################################################
[mcu cartographer]
canbus_uuid: d01f7feb964e

[cartographer]
mcu: cartographer
x_offset: 0
y_offset: 21.1
travel_speed: 50
verbose: false

[cartographer scan]
probe_speed: 5
mesh_runs: 1
mesh_direction: x
mesh_height: 3
mesh_path: snake

[cartographer touch]
samples: 3
max_samples: 10
sample_range: 0.01
retract_distance: 2
UNSAFE_max_touch_temperature: 150

[cartographer coil]
name: cartographer_coil
min_temp: 0
max_temp: 105

[temperature_sensor cartographer]
sensor_type: temperature_mcu
sensor_mcu: cartographer
min_temp: 5
max_temp: 105

[adxl345 cartographer]
cs_pin: cartographer:PA0
spi_bus: spi1

[axis_twist_compensation]

################################################################################
# Motion System (Steppers, TMCs, Autotune)
################################################################################
# --- X Axis (B Motor) ---
[stepper_x]
step_pin: PE2
dir_pin: PE1
enable_pin: !PE4
rotation_distance: 32
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: 0
position_max: 180
position_endstop: 180
homing_speed: 40
homing_retract_dist: 0
homing_positive_dir: True

[tmc2209 stepper_x]
uart_pin: PE3
diag_pin: ^PF3
interpolate: True
run_current: 0.90
sense_resistor: 0.110

[autotune_tmc stepper_x]
motor: moons-ms14hs5p4150
tuning_goal: performance
sg4_thrs: 200 # Use highest value that will not cause a false trigger in sensorless homing
voltage: 24

# --- Y Axis (A Motor) ---
[stepper_y]
step_pin: PE6
dir_pin: PE5
enable_pin: !PC14
rotation_distance: 32
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: 0
position_max: 180
position_endstop: 180
homing_speed: 40
homing_retract_dist: 0
homing_positive_dir: True

[tmc2209 stepper_y]
uart_pin: PC13
diag_pin: ^PF4
interpolate: True
run_current: 0.90
sense_resistor: 0.110

[autotune_tmc stepper_y]
motor: moons-ms14hs5p4150
tuning_goal: performance
sg4_thrs: 200 # Use highest value that will not cause a false trigger in sensorless homing
voltage: 24

# --- Z0 Axis (Front Left) ---
[stepper_z]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PE0
rotation_distance: 8
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_min: -5
position_max: 160
homing_retract_dist: 0
homing_speed: 8
second_homing_speed: 3

[tmc2209 stepper_z]
uart_pin: PB9
interpolate: True
run_current: 0.40
sense_resistor: 0.110

[autotune_tmc stepper_z]
motor: moons-le174s-t0808-200-ar3-s-065
tuning_goal: silent
voltage: 24

# --- Z1 Axis (Rear) ---
[stepper_z1]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB6
rotation_distance: 8
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z1]
uart_pin: PB5
interpolate: True
run_current: 0.40
sense_resistor: 0.110

[autotune_tmc stepper_z1]
motor: moons-le174s-t0808-200-ar3-s-065
tuning_goal: silent
voltage: 24

# --- Z2 Axis (Front Right) ---
[stepper_z2]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
rotation_distance: 8
microsteps: 32
full_steps_per_rotation: 200

[tmc2209 stepper_z2]
uart_pin: PG14
interpolate: True
run_current: 0.40
sense_resistor: 0.110

[autotune_tmc stepper_z2]
motor: moons-le174s-t0808-200-ar3-s-065
tuning_goal: silent
voltage: 24

################################################################################
# Extruder & Bed Heaters
################################################################################
# --- Extruder ---
[extruder]
step_pin: ebb36:PD0
dir_pin: !ebb36:PD1
enable_pin: !ebb36:PD2
rotation_distance: 47.088
gear_ratio: 9:1
microsteps: 16
full_steps_per_rotation: 200

# Filament & Nozzle
nozzle_diameter: 0.400
filament_diameter: 1.75
max_extrude_only_velocity: 60
max_extrude_only_distance: 200
max_extrude_cross_section: 5

# Heater
heater_pin: ebb36:PB13
min_temp: 10
max_temp: 330
max_power: 1.0
min_extrude_temp: 170

# Sensor (PT1000/MAX31865)
sensor_type: MAX31865
sensor_pin: ebb36:PA4
spi_software_sclk_pin: ebb36:PA5
spi_software_mosi_pin: ebb36:PA7
spi_software_miso_pin: ebb36:PA6
rtd_nominal_r: 1000
rtd_reference_r: 4300
rtd_num_of_wires: 2
rtd_use_50Hz_filter: True

# Control (PID)
#control: pid
#pid_kp: 34.577
#pid_ki: 12.807
#pid_kd: 23.339

# Pressure Advance
pressure_advance: 0.030
pressure_advance_smooth_time: 0.025

[tmc2209 extruder]
uart_pin: ebb36:PA15
interpolate: True
run_current: 0.60
sense_resistor: 0.110

[autotune_tmc extruder]
motor: ldo-36sth20-1004ahg-9T
tuning_goal: performance
voltage: 24

[firmware_retraction]
retract_length: 0.8
retract_speed: 60
unretract_extra_length: 0
unretract_speed: 60

# --- Bed Heater ---
[heater_bed]
heater_pin: PF5
sensor_type: Generic 3950
sensor_pin: PB1
max_power: 0.6
min_temp: 0
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769

################################################################################
# Cooling & Fans
################################################################################
# --- Part Cooling Fan ---
[fan]
pin: ebb36:PA1
max_power: 1.0
kick_start_time: 0.5
off_below: 0.10
cycle_time: 0.010

# --- Hotend Cooling Fan ---
[heater_fan hotend_fan]
pin: ebb36:PA0
tachometer_pin: ^ebb36:PB9
tachometer_ppr: 2
tachometer_poll_interval: 0.0009
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

# --- Hotend Fan Guard (Background Monitoring) ---
[delayed_gcode _FAN_GUARD]
initial_duration: 5.0
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        rpm=printer['heater_fan hotend_fan'].rpm|default(0)|float,
        actual_temp=printer.extruder.temperature|float,
        target_temp=printer.extruder.target|float,
        print_status=printer.print_stats.state|default("standby")|string|lower
    ) %}

    {% if ref.target_temp >= 50.0 and ref.actual_temp >= 55.0 %}         ; Monitor ALWAYS if active heating is requested
        {% if ref.rpm < 7000 %}                                          ; Check if RPM drops below critical threshold
            _NOTIFY MSG="System: Error - Hotend fan failed!"
            SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0              ; Turn off hotend heater immediately
            {% if ref.print_status == "printing" %}                      ; Check if printer is active
                PAUSE                                                    ; Pause the print safely
            {% endif %}
        {% endif %}
    {% endif %}

    ; --- LOOP ---
    UPDATE_DELAYED_GCODE ID=_FAN_GUARD DURATION=5.0                      ; Restart the monitoring loop

# --- Electronics Fan ---
[controller_fan controller_fan]
pin: PF7
kick_start_time: 2
max_power: 0.60
heater: extruder
stepper: stepper_x, stepper_y, stepper_z

# --- Nevermore filter ---
[fan_generic nevermore]
pin: PF9
max_power: 1.0
shutdown_speed: 0.0
kick_start_time: 5.0
cycle_time: 0.01
off_below: 0.1

################################################################################
# Probing, Leveling & Resonance
################################################################################
[z_tilt]
z_positions:
    -50, -13
     90, 217
    213, -13
points:
     20, 10
     90, 155
    160, 10
speed: 150
horizontal_move_z: 15
retry_tolerance: 0.0100

[bed_mesh]
zero_reference_position: 90, 90
speed: 150
horizontal_move_z: 3
mesh_min: 10, 25
mesh_max: 170, 170
probe_count: 20, 20
adaptive_margin: 10
mesh_pps: 0, 0

[adxl345 ebb36]
cs_pin: ebb36:PB12
spi_bus: spi2_PB2_PB11_PB10
axes_map: x,y,z

[resonance_tester]
accel_chip: adxl345 cartographer
probe_points: 90, 90, 20

[input_shaper]
shaper_type_x: mzv
shaper_freq_x: 50.0
shaper_type_y: mzv
shaper_freq_y: 50.0

################################################################################
# System Sensors & Peripherals
################################################################################
# --- MCU Temperatures ---
[temperature_sensor pi]
sensor_type: temperature_host
min_temp: 5
max_temp: 100
gcode_id: pi_th

[temperature_sensor mcu]
sensor_type: temperature_mcu
min_temp: 5
max_temp: 100
gcode_id: mcu_th

[temperature_sensor mcu_ebb36]
sensor_type: temperature_mcu
sensor_mcu: ebb36
min_temp: 5
max_temp: 100
gcode_id: ebb36_th

[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PC5
min_temp: 0
max_temp: 70
gcode_id: chamber_th

# --- Filament Sensors (BTT SFS v2) ---
[filament_switch_sensor switch_sensor]
switch_pin: ^PF0
pause_on_runout: false
runout_gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        print_status=printer.print_stats.state|default("standby")|string|lower
    ) %}

    {% if ref.print_status == "printing" %}             ; Check if printer is active
        _NOTIFY MSG="Filament: Switch detected runout."
        M600                                            ; Trigger filament change
    {% endif %}
insert_gcode:
    _NOTIFY MSG="Filament: Switch detected insertion."

[filament_motion_sensor encoder_sensor]
switch_pin: ^PC15
detection_length: 2.88
extruder: extruder
pause_on_runout: false
runout_gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        print_status=printer.print_stats.state|default("standby")|string|lower
    ) %}

    {% if ref.print_status == "printing" %}              ; Check if printer is active
        _NOTIFY MSG="Filament: Encoder detected runout."
        M600                                             ; Trigger filament change
    {% endif %}
insert_gcode:
    _NOTIFY MSG="Filament: Encoder detected insertion."

# --- Lighting ---
[multi_pin caselight_pins]
pins: PF6, PF8

[output_pin caselight]
pin: multi_pin:caselight_pins
pwm: True
cycle_time: 0.01
value: 1.0
shutdown_value: 0.0

[neopixel toolhead_leds]
pin: ebb36:PD3
chain_count: 3
color_order: GRB

# --- Idle Timeout ---
[idle_timeout]
timeout: 3600
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        is_paused=printer.pause_resume.is_paused
    ) %}

    {% if ref.is_paused %}                                                         ; Check if system is paused
        _NOTIFY MSG="System: Idle timeout during pause. Steppers ON, Heaters OFF."
        TURN_OFF_HEATERS                                                           ; Turn off heaters only
    {% else %}                                                                     ; Fallback for true idle
        _NOTIFY MSG="System: Idle timeout. Steppers OFF, Heaters OFF."
        TURN_OFF_HEATERS                                                           ; Turn off heaters
        M107                                                                       ; Turn off part cooling fan
        SET_FAN_SPEED FAN=nevermore SPEED=0.0                                      ; Turn off Nevermore filter
        UPDATE_DELAYED_GCODE ID=STOP_NEVERMORE DURATION=0                          ; Cancel any pending filter shutdown timer
        M84                                                                        ; Disable steppers
        _SET_LOGO_LEDS_OFF
        _STATUS_OFF
    {% endif %}

################################################################################
# Macro Variables
################################################################################
[gcode_macro _MY_VARS]
; --- Kinematics & Travel ---
variable_travel_factor_xy      : 0.8    ; Set travel factor for X and Y axes
variable_travel_factor_z       : 0.8    ; Set travel factor for Z axis
; --- Filament Management ---
variable_fil_load_length       : 100.0  ; Set filament load length
variable_fil_load_speed        : 600    ; Set filament load speed
variable_fil_unload_length     : 100.0  ; Set filament unload length
variable_fil_unload_speed      : 300    ; Set filament unload speed
variable_fil_purge_length      : 40.0   ; Set filament purge length
variable_fil_purge_speed       : 100    ; Set filament purge speed
variable_blob_speed            : 200    ; Set prime blob speed
; --- Temperatures & Times ---
variable_preheat_temp          : 150.0  ; Set nozzle preheat temp
variable_bed_default_temp      : 60.0   ; Set default bed temperature fallback
variable_ext_default_temp      : 200.0  ; Set default extruder temperature fallback
variable_fil_default_temp      : 220.0  ; Set default temperature for filament handling
variable_chamber_fallback_temp : 45.0   ; Target chamber temp if bed is hot and no slicer param
variable_chamber_fallback_bed  : 90.0   ; Bed temp threshold to trigger chamber fallback
variable_filter_start_temp     : 90.0   ; Minimum bed temp to trigger VOC filtration (e.g., for ABS/ASA)
variable_base_soak_time        : 2      ; Set base thermal soak time for mechanical stabilization (in minutes)
; --- Homing & Kinematics ---
variable_home_current          : 0.50   ; Set sensorless homing current
; --- Z-Heights ---
variable_z_hop                 : 10.0   ; Set default Z hop height
variable_z_soak                : 15.0   ; Set Z height for thermal soak
variable_z_purge               : 10.0   ; Set Z height for purging
gcode:
    ; Mandatory G-Code section for variable macros

################################################################################
# Homing & Leveling Macros
################################################################################
[gcode_macro CONDITIONAL_HOME]
description: Homing only if necessary
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        homed=printer.toolhead.homed_axes
    ) %}

    {% if "xyz" not in ref.homed %}                             ; Check if all axes are homed
        _NOTIFY MSG="System: Axes not homed. Executing G28..."
        G28                                                     ; Execute full homing
    {% else %}                                                  ; Fallback if already homed
        _NOTIFY MSG="System: Axes already homed. Skipping G28."
    {% endif %}

[gcode_macro _HOME_AXIS]
description: Helper for sensorless homing
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        vars=printer["gcode_macro _MY_VARS"],
        run_x=printer['tmc2209 stepper_x'].run_current|float,
        run_y=printer['tmc2209 stepper_y'].run_current|float
    ) %}

    ; --- PARAMETERS ---
    {% set param = namespace(
        axis=params.AXIS|string|lower
    ) %}

    ; --- STATE & LOGIC ---
    {% set logic = namespace(
        home_current=ref.vars.home_current|float
    ) %}

    _NOTIFY MSG="System: Homing {param.axis|upper}..."
    SAVE_GCODE_STATE NAME=STATE_HOME_AXIS
    M400                                                           ; Wait for moves
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={logic.home_current} ; Set homing current X
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={logic.home_current} ; Set homing current Y
    G4 P500                                                        ; Wait for StallGuard stability

    G28 {param.axis|upper}                                         ; Execute homing
    G91                                                            ; Set relative positioning
    G0 {param.axis|upper}-10 F1200                                 ; Move away from rail
    G90                                                            ; Set absolute positioning
    G4 P500                                                        ; Wait for StallGuard clear

    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={ref.run_x}          ; Restore current X
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={ref.run_y}          ; Restore current Y
    RESTORE_GCODE_STATE NAME=STATE_HOME_AXIS

[homing_override]
axes: xyz
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        th=printer.toolhead,
        vars=printer["gcode_macro _MY_VARS"],
        max_xy_vel=printer.configfile.settings.printer.max_velocity|float,
        max_z_vel=printer.configfile.settings.printer.max_z_velocity|float
    ) %}

    ; --- PARAMETERS ---
    {% set param = namespace(
        req_x='X' in params,
        req_y='Y' in params,
        req_z='Z' in params,
        req_none='X' not in params and 'Y' not in params and 'Z' not in params
    ) %}

    ; --- STATE & LOGIC ---
    {% set logic = namespace(
        home_x=param.req_none or param.req_x,
        home_y=param.req_none or param.req_y,
        home_z=param.req_none or param.req_z,
        homed=ref.th.homed_axes
    ) %}

    ; --- KINEMATICS & SPEEDS ---
    {% set speed = namespace(
        travel_xy=(ref.max_xy_vel * ref.vars.travel_factor_xy * 60)|int,
        travel_z=(ref.max_z_vel * ref.vars.travel_factor_z * 60)|int
    ) %}

    ; --- POSITIONS ---
    {% set pos = namespace(
        center_x=ref.th.axis_maximum.x|float / 2.0,
        center_y=ref.th.axis_maximum.y|float / 2.0,
        z_hop=ref.vars.z_hop|float,
        z_safe=[ref.th.position.z + ref.vars.z_hop|float, ref.th.axis_maximum.z]|min
    ) %}

    _STATUS_HOMING
    G90                                                                                                         ; Set absolute positioning strictly once

    {% if "z" in logic.homed %}                                                                                 ; Check if Z is homed safely
        G0 Z{pos.z_safe} F{speed.travel_z}                                                                      ; Perform safe Z hop
    {% endif %}

    {% if logic.home_x %}                                                                                       ; Check if X requires homing
        _HOME_AXIS AXIS=X                                                                                       ; Home X axis
    {% endif %}

    {% if logic.home_y %}                                                                                       ; Check if Y requires homing
        _HOME_AXIS AXIS=Y                                                                                       ; Home Y axis
    {% endif %}

    {% if logic.home_z %}                                                                                       ; Check if Z requires homing
        {% if ("x" not in logic.homed and not logic.home_x) or ("y" not in logic.homed and not logic.home_y) %}
            _HOME_AXIS AXIS=X                                                                                   ; Force home X axis
            _HOME_AXIS AXIS=Y                                                                                   ; Force home Y axis
        {% endif %}
        G0 X{pos.center_x} Y{pos.center_y} F{speed.travel_xy}                                                   ; Move to center
        _NOTIFY MSG="System: Homing Z..."
        G28 Z                                                                                                   ; Home Z axis
        G0 Z{pos.z_hop} F{speed.travel_z}                                                                       ; Perform Z hop
    {% endif %}

    M400                                                                                                        ; Wait for moves
    _STATUS_READY

[gcode_macro Z_TILT_ADJUST]
rename_existing: _MY_Z_TILT_ADJUST
gcode:
    _STATUS_LEVELING
    _NOTIFY MSG="Process: Adjusting Z-tilt..."
    _MY_Z_TILT_ADJUST {rawparams} ; Execute native command
    _STATUS_READY

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _MY_BED_MESH_CALIBRATE
gcode:
    _STATUS_MESHING
    _NOTIFY MSG="Process: Generating mesh..."
    _MY_BED_MESH_CALIBRATE {rawparams} ; Execute native command
    _STATUS_READY

################################################################################
# Print Lifecycle Macros
################################################################################
[gcode_macro PRINT_START]
description: Main startup procedure
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        vars=printer["gcode_macro _MY_VARS"],
        th=printer.toolhead,
        max_xy_vel=printer.configfile.settings.printer.max_velocity|float,
        max_z_vel=printer.configfile.settings.printer.max_z_velocity|float
    ) %}

    ; --- PARAMETERS ---
    {% set param = namespace(
        bed=params.BED_TEMP|default(ref.vars.bed_default_temp)|float,
        ext=params.EXTRUDER_TEMP|default(ref.vars.ext_default_temp)|float,
        cha=params.CHAMBER|default(0.0)|float
    ) %}

    ; --- STATE & LOGIC ---
    {% set logic = namespace(
        bed=param.bed,
        ext=param.ext,
        cha=param.cha if param.cha > 0.0 else (ref.vars.chamber_fallback_temp if param.bed >= ref.vars.chamber_fallback_bed else 15.0),
        preheat=ref.vars.preheat_temp,
        filter=ref.vars.filter_start_temp
    ) %}

    ; --- KINEMATICS & SPEEDS ---
    {% set speed = namespace(
        travel_xy=(ref.max_xy_vel * ref.vars.travel_factor_xy * 60)|int,
        travel_z=(ref.max_z_vel * ref.vars.travel_factor_z * 60)|int
    ) %}

    ; --- POSITIONS ---
    {% set pos = namespace(
        center_x=ref.th.axis_maximum.x|float / 2.0,
        center_y=ref.th.axis_maximum.y|float / 2.0,
        purge_x=ref.th.axis_minimum.x|float + 5.0,
        purge_y=ref.th.axis_minimum.y|float + 5.0,
        z_soak=ref.vars.z_soak|float,
        z_purge=ref.vars.z_purge|float
    ) %}

    ; --- TIMERS ---
    {% set timer = namespace(
        soak_ms=(ref.vars.base_soak_time * 60000)|int,
        soak_min=ref.vars.base_soak_time|int
    ) %}

    _STATUS_BUSY
    UPDATE_DELAYED_GCODE ID=STOP_NEVERMORE DURATION=0                            ; Cancel any pending filter shutdown timer
    G21                                                                          ; Set metric system
    G90                                                                          ; Set absolute positioning
    M83                                                                          ; Set relative extruder
    _RESET_STATE                                                                 ; Clear all transformations

    _NOTIFY MSG="Process: Heating bed to {logic.bed}C..."
    _STATUS_HEATING
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={logic.bed}                  ; Heat bed without blocking
    M109 S{logic.preheat}                                                        ; Preheat nozzle and wait for temperature to settle
    CONDITIONAL_HOME                                                             ; Execute conditional homing

    {% if logic.bed >= logic.filter %}                                           ; Check if target bed temp requires VOC filtration
        _NOTIFY MSG="Process: Enabling Nevermore VOC filter."
        SET_FAN_SPEED FAN=nevermore SPEED=1.0                                    ; Enable internal filter
    {% endif %}

    _STATUS_HEATING
    _NOTIFY MSG="Process: Thermal soaking: Waiting for bed to reach {logic.bed}C..."
    G0 Z{pos.z_soak} F{speed.travel_z}                                           ; Move to soak height safely
    G0 X{pos.center_x} Y{pos.center_y} F{speed.travel_xy}                        ; Move to bed center
    M190 S{logic.bed}                                                            ; Wait for bed temp to settle

    _NOTIFY MSG="Process: Mandatory Bed Soak ({timer.soak_min}min)..."
    G4 P{timer.soak_ms}                                                          ; Execute base thermal soak

    _NOTIFY MSG="Process: Waiting for chamber to reach {logic.cha}C..."
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={logic.cha}     ; Block until chamber temp is reached

    Z_TILT_ADJUST                                                                ; Execute mechanical leveling
    CARTOGRAPHER_TOUCH_HOME                                                      ; Cartographer touch home for real Z0
    BED_MESH_CALIBRATE ADAPTIVE=1                                                ; Generate bed mesh

    _NOTIFY MSG="Process: Heating nozzle to {logic.ext}C..."
    _STATUS_HEATING
    G0 Z{pos.z_purge} F{speed.travel_z}                                          ; Set to purge height
    G0 X{pos.purge_x} Y{pos.purge_y} F{speed.travel_xy}                          ; Move to purge XY position
    M109 S{logic.ext}                                                            ; Heat nozzle and wait for temperature to settle
    PRIME_BLOB                                                                   ; Execute priming

    _TOGGLE_FILAMENT_SENSORS ENABLE=0                                            ; Disable runout sensors temporarily
    _STATUS_PRINTING
    _NOTIFY MSG="Process: Print job started."

[gcode_macro PRINT_END]
description: Finalize print job
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        nevermore_speed=printer['fan_generic nevermore'].speed|default(0.0)
    ) %}

    M400                                                         ; Wait for moves
    G10                                                          ; Firmware retraction
    TURN_OFF_HEATERS                                             ; Turn off heaters early
    M107                                                         ; Turn off part cooling fan
    _PARK_TOOLHEAD                                               ; Execute parking routine
    M84                                                          ; Disable steppers
    _TOGGLE_FILAMENT_SENSORS ENABLE=1                            ; Enable runout sensors
    _RESET_STATE                                                 ; Clear all transformations
    _STATUS_READY

    {% if ref.nevermore_speed > 0.0 %}                           ; Check if filter is active
        _NOTIFY MSG="Process: Print finished. Filtering VOCs..."
        UPDATE_DELAYED_GCODE ID=STOP_NEVERMORE DURATION=600      ; Schedule Nevermore shutdown
    {% else %}                                                   ; Fallback if filter is off
        _NOTIFY MSG="Process: Print finished."
    {% endif %}

[delayed_gcode STOP_NEVERMORE]
gcode:
    SET_FAN_SPEED FAN=nevermore SPEED=0.0 ; Disable Nevermore filter
    _NOTIFY MSG="System: Filter stopped."

[gcode_macro PRIME_BLOB]
description: Purge nozzle via prime blob
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        th=printer.toolhead,
        vars=printer["gcode_macro _MY_VARS"],
        max_xy_vel=printer.configfile.settings.printer.max_velocity|float
    ) %}

    ; --- KINEMATICS & SPEEDS ---
    {% set speed = namespace(
        blob=ref.vars.blob_speed|int,
        travel_xy=(ref.max_xy_vel * ref.vars.travel_factor_xy * 60)|int,
        breakaway=(ref.max_xy_vel * 60)|int
    ) %}

    ; --- POSITIONS ---
    {% set logic = namespace(
        max_y=ref.th.axis_maximum.y|float,
        base_y=ref.th.axis_minimum.y|float + 5.0
    ) %}
    {% set pos = namespace(
        purge_x=ref.th.axis_minimum.x|float + 5.0,
        purge_y=logic.base_y,
        wipe_y1=[logic.base_y + 15.0, logic.max_y]|min,
        wipe_y2=[logic.base_y + 20.0, logic.max_y]|min,
        wipe_y3=[logic.base_y + 25.0, logic.max_y]|min,
        wipe_y4=[logic.base_y + 30.0, logic.max_y]|min,
        wipe_y5=[logic.base_y + 35.0, logic.max_y]|min,
        wipe_yf=[logic.base_y + 40.0, logic.max_y]|min,
        breakaway_y=[logic.base_y + 90.0, logic.max_y]|min
    ) %}

    _STATUS_CLEANING
    _NOTIFY MSG="Process: Priming nozzle..."
    _TOGGLE_FILAMENT_SENSORS ENABLE=0                        ; Disable runout sensors
    SAVE_GCODE_STATE NAME=STATE_PRIME_BLOB
    G90                                                      ; Set absolute positioning
    M83                                                      ; Set relative extruder
    G0 X{pos.purge_x} Y{pos.purge_y} Z0.5 F{speed.travel_xy} ; Move to start
    G1 F60 E20                                               ; Extrude slow blob
    M106 S102                                                ; Fan to 40 percent
    G1 Z5 F100 E5                                            ; Lift and extrude
    G1 F{speed.blob} Y{pos.wipe_y1} E1                       ; Wipe 1
    G1 F{speed.blob} Y{pos.wipe_y2} Z3.8 E0.5                ; Wipe 2
    G1 F{speed.blob} Y{pos.wipe_y3} Z2.6 E0.5                ; Wipe 3
    G1 F{speed.blob} Y{pos.wipe_y4} Z1.4 E0.5                ; Wipe 4
    G1 F{speed.blob} Y{pos.wipe_y5} Z0.2 E0.5                ; Wipe 5
    M107                                                     ; Turn off part cooling fan
    G1 F{speed.blob} Y{pos.wipe_yf} Z0.2 E0.6                ; Final linear wipe
    G0 Y{pos.breakaway_y} F{speed.breakaway}                 ; Fast breakaway
    M400                                                     ; Wait for moves
    RESTORE_GCODE_STATE NAME=STATE_PRIME_BLOB
    _TOGGLE_FILAMENT_SENSORS ENABLE=1                        ; Enable runout sensors
    _STATUS_READY

################################################################################
# Filament Management Macros
################################################################################
[gcode_macro LOAD_FILAMENT]
description: Load filament
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        vars=printer["gcode_macro _MY_VARS"],
        min_ext=printer.configfile.settings.extruder.min_extrude_temp|float
    ) %}

    ; --- PARAMETERS ---
    {% set param = namespace(
        temp=params.TEMP|default(ref.vars.fil_default_temp)|float
    ) %}

    ; --- STATE & LOGIC ---
    {% set logic = namespace(
        target=param.temp|int if param.temp >= ref.min_ext else ref.vars.fil_default_temp
    ) %}

    ; --- KINEMATICS & SPEEDS ---
    {% set dist = namespace(
        load=ref.vars.fil_load_length|float,
        purge=ref.vars.fil_purge_length|float
    ) %}
    {% set speed = namespace(
        load=ref.vars.fil_load_speed|int,
        purge=ref.vars.fil_purge_speed|int
    ) %}

    ; --- TIMERS ---
    {% set timer = namespace(
        stabilize=1000
    ) %}

    _STATUS_HEATING                                              ; Set toolhead LEDs
    _NOTIFY MSG="Filament: Heating hotend to {logic.target}C..."
    M109 S{logic.target}                                         ; Heat nozzle and wait for temperature to settle
    _STATUS_BUSY                                                 ; Set toolhead LEDs
    _TOGGLE_FILAMENT_SENSORS ENABLE=0                            ; Disable runout sensors
    SAVE_GCODE_STATE NAME=STATE_LOAD_FILAMENT                    ; Save gcode state
    M83                                                          ; Set relative extruder
    _NOTIFY MSG="Filament: Loading {dist.load}mm..."
    G1 E{dist.load} F{speed.load}                                ; Initial feed
    G4 P{timer.stabilize}                                        ; Stabilize
    _NOTIFY MSG="Filament: Purging {dist.purge}mm..."
    G1 E{dist.purge} F{speed.purge}                              ; Purge
    G10                                                          ; Retract
    M400                                                         ; Wait for moves
    RESTORE_GCODE_STATE NAME=STATE_LOAD_FILAMENT                 ; Restore gcode state
    _TOGGLE_FILAMENT_SENSORS ENABLE=1                            ; Enable runout sensors
    _STATUS_READY                                                ; Set toolhead LEDs
    _NOTIFY MSG="Filament: Load complete."

[gcode_macro UNLOAD_FILAMENT]
description: Eject filament
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        vars=printer["gcode_macro _MY_VARS"],
        min_ext=printer.configfile.settings.extruder.min_extrude_temp|float
    ) %}

    ; --- PARAMETERS ---
    {% set param = namespace(
        temp=params.TEMP|default(ref.vars.fil_default_temp)|float
    ) %}

    ; --- STATE & LOGIC ---
    {% set logic = namespace(
        target=param.temp|int if param.temp >= ref.min_ext else ref.vars.fil_default_temp
    ) %}

    ; --- KINEMATICS & SPEEDS ---
    {% set dist = namespace(
        prime=15.0,
        rapid=20.0,
        unload=ref.vars.fil_unload_length|float
    ) %}
    {% set speed = namespace(
        prime=300,
        rapid=3000,
        unload=ref.vars.fil_unload_speed|int
    ) %}

    _STATUS_HEATING                                              ; Set toolhead LEDs
    _NOTIFY MSG="Filament: Heating hotend to {logic.target}C..."
    M109 S{logic.target}                                         ; Heat nozzle and wait for temperature to settle
    _STATUS_BUSY                                                 ; Set toolhead LEDs
    _TOGGLE_FILAMENT_SENSORS ENABLE=0                            ; Disable runout sensors
    SAVE_GCODE_STATE NAME=STATE_UNLOAD_FILAMENT                  ; Save gcode state
    M83                                                          ; Set relative extruder
    _NOTIFY MSG="Filament: Unloading {dist.unload}mm..."
    G1 E{dist.prime} F{speed.prime}                              ; Prime purge
    G1 E-{dist.rapid} F{speed.rapid}                             ; Rapid pull
    G1 E-{dist.unload} F{speed.unload}                           ; Final ejection
    M400                                                         ; Wait for moves
    RESTORE_GCODE_STATE NAME=STATE_UNLOAD_FILAMENT               ; Restore gcode state
    _TOGGLE_FILAMENT_SENSORS ENABLE=1                            ; Enable runout sensors
    _STATUS_READY                                                ; Set toolhead LEDs
    _NOTIFY MSG="Filament: Unload complete."

[gcode_macro M600]
description: Filament change
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        print_temp=printer.extruder.target|int
    ) %}

    PAUSE                                                                      ; Pause print
    _STATUS_BUSY
    UNLOAD_FILAMENT TEMP={ref.print_temp}                                      ; Eject filament
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0                            ; Extruder off
    _STATUS_BUSY
    _NOTIFY MSG="Action: Change filament ({ref.print_temp}C) or clear runout."

################################################################################
# Parking & Movement Macros
################################################################################
[gcode_macro _PARK_TOOLHEAD]
description: Helper macro for safe toolhead parking
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        th=printer.toolhead,
        vars=printer["gcode_macro _MY_VARS"],
        client=printer["gcode_macro _CLIENT_VARIABLE"],
        max_xy_vel=printer.configfile.settings.printer.max_velocity|float,
        max_z_vel=printer.configfile.settings.printer.max_z_velocity|float
    ) %}

    ; --- PARAMETERS ---
    {% set param = namespace(
        z_hop=params.Z_HOP|default(ref.client.custom_park_dz)|float
    ) %}

    ; --- KINEMATICS & SPEEDS ---
    {% set speed = namespace(
        travel_xy=(ref.max_xy_vel * ref.vars.travel_factor_xy * 60)|int,
        travel_z=(ref.max_z_vel * ref.vars.travel_factor_z * 60)|int
    ) %}

    ; --- POSITIONS ---
    {% set pos = namespace(
        x=[ref.client.custom_park_x|float, ref.th.axis_maximum.x]|min,
        y=[ref.client.custom_park_y|float, ref.th.axis_maximum.y]|min,
        z=[ref.th.position.z + param.z_hop, ref.th.axis_maximum.z]|min
    ) %}

    SAVE_GCODE_STATE NAME=STATE_PARK_TOOLHEAD
    G90                                          ; Set absolute positioning
    G0 Z{pos.z} F{speed.travel_z}                ; Lift toolhead strictly vertically first
    G0 X{pos.x} Y{pos.y} F{speed.travel_xy}      ; Move toolhead to park XY
    M400                                         ; Wait for moves
    RESTORE_GCODE_STATE NAME=STATE_PARK_TOOLHEAD

[gcode_macro CENTER]
description: Move toolhead to center
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        th=printer.toolhead,
        vars=printer["gcode_macro _MY_VARS"],
        max_xy_vel=printer.configfile.settings.printer.max_velocity|float,
        max_z_vel=printer.configfile.settings.printer.max_z_velocity|float
    ) %}

    ; --- KINEMATICS & SPEEDS ---
    {% set speed = namespace(
        travel_xy=(ref.max_xy_vel * ref.vars.travel_factor_xy * 60)|int,
        travel_z=(ref.max_z_vel * ref.vars.travel_factor_z * 60)|int
    ) %}

    ; --- POSITIONS ---
    {% set pos = namespace(
        actual_z=ref.th.position.z|float,
        center_x=ref.th.axis_maximum.x|float / 2.0,
        center_y=ref.th.axis_maximum.y|float / 2.0,
        center_z=ref.th.axis_maximum.z|float / 2.0
    ) %}

    _STATUS_BUSY
    _NOTIFY MSG="System: Moving toolhead to center..."
    SAVE_GCODE_STATE NAME=STATE_CENTER
    G90                                                   ; Set absolute positioning
    {% if pos.actual_z < pos.center_z %}                  ; Check if Z is below center
        G0 Z{pos.center_z} F{speed.travel_z}              ; Lift Z safely
    {% endif %}
    G0 X{pos.center_x} Y{pos.center_y} F{speed.travel_xy} ; Move to XY center
    M400                                                  ; Wait for moves
    RESTORE_GCODE_STATE NAME=STATE_CENTER
    _STATUS_READY

################################################################################
# Slicer Compatibility Macros (Marlin / RepRap)
################################################################################
[gcode_macro G27]
description: Park Toolhead
gcode:
    _PARK_TOOLHEAD

[gcode_macro G29]
description: Bed mesh
gcode:
    BED_MESH_CALIBRATE ; Generate bed mesh

[gcode_macro G32]
description: Home and Bed leveling
gcode:
    CONDITIONAL_HOME        ; Execute conditional homing
    Z_TILT_ADJUST           ; Execute mechanical leveling
    CARTOGRAPHER_TOUCH_HOME ; Cartographer touch home

[gcode_macro M108]
description: Cancel Heating
gcode:
    _NOTIFY MSG="System: Command M108 (Cancel Heating) ignored."

[gcode_macro M116]
description: Wait for all temperatures
gcode:
    ; Dummy macro to prevent console spam from RepRap slicers

[gcode_macro M201]
description: Set Max Acceleration
gcode:
    {% if 'X' in params or 'Y' in params %}
        ; --- REFERENCES ---
        {% set ref = namespace(
            max_val=printer.configfile.settings.printer.max_accel|float
        ) %}

        ; --- PARAMETERS ---
        {% set param = namespace(
            req_val=params.X|default(params.Y)|float
        ) %}

        ; --- STATE & LOGIC ---
        {% set logic = namespace(
            safe=[param.req_val, ref.max_val]|min
        ) %}

        SET_VELOCITY_LIMIT ACCEL={logic.safe} ; Apply validated acceleration limit
    {% endif %}

[gcode_macro M203]
description: Set Max Feedrate
gcode:
    {% if 'X' in params or 'Y' in params %}
        ; --- REFERENCES ---
        {% set ref = namespace(
            max_val=printer.configfile.settings.printer.max_velocity|float
        ) %}

        ; --- PARAMETERS ---
        {% set param = namespace(
            req_val=params.X|default(params.Y)|float
        ) %}

        ; --- STATE & LOGIC ---
        {% set logic = namespace(
            safe=[param.req_val, ref.max_val]|min
        ) %}

        SET_VELOCITY_LIMIT VELOCITY={logic.safe} ; Apply validated velocity limit
    {% endif %}

[gcode_macro M205]
description: Set Jerk
gcode:
    {% if 'X' in params or 'Y' in params %}
        ; --- REFERENCES ---
        {% set ref = namespace(
            max_val=printer.configfile.settings.printer.square_corner_velocity|float
        ) %}

        ; --- PARAMETERS ---
        {% set param = namespace(
            req_val=params.X|default(params.Y)|float
        ) %}

        ; --- STATE & LOGIC ---
        {% set logic = namespace(
            safe=[param.req_val, ref.max_val]|min
        ) %}

        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={logic.safe} ; Apply validated jerk limit
    {% endif %}

[gcode_macro M300]
description: Play Tone
gcode:
    ; --- PARAMETERS ---
    {% set param = namespace(
        freq=params.S|default(1000)|int,
        dur=params.P|default(100)|int
    ) %}
    ; Trigger an [output_pin beeper] here if hardware is added later

[gcode_macro M572]
description: Set Pressure Advance
gcode:
    {% if 'S' in params %}
        ; --- PARAMETERS ---
        {% set param = namespace(
            pa=params.S|float
        ) %}

        SET_PRESSURE_ADVANCE ADVANCE={param.pa} ; Apply Pressure Advance
    {% endif %}

[gcode_macro M601]
description: Pause print
gcode:
    PAUSE ; Trigger native pause

[gcode_macro M701]
description: Load filament
gcode:
    ; --- PARAMETERS ---
    {% set param = namespace(
        target_temp=params.S|default(params.T|default(0))|float
    ) %}

    {% if param.target_temp > 0 %}
        LOAD_FILAMENT TEMP={param.target_temp}
    {% else %}
        LOAD_FILAMENT
    {% endif %}

[gcode_macro M702]
description: Unload filament
gcode:
    ; --- PARAMETERS ---
    {% set param = namespace(
        target_temp=params.S|default(params.T|default(0))|float
    ) %}

    {% if param.target_temp > 0 %}
        UNLOAD_FILAMENT TEMP={param.target_temp}
    {% else %}
        UNLOAD_FILAMENT
    {% endif %}

[gcode_macro M900]
description: Set Pressure Advance
gcode:
    {% if 'K' in params %}
        ; --- PARAMETERS ---
        {% set param = namespace(
            pa=params.K|float
        ) %}

        SET_PRESSURE_ADVANCE ADVANCE={param.pa} ; Apply Pressure Advance
    {% endif %}

################################################################################
# Core Helper Macros
################################################################################
[gcode_macro _NOTIFY]
description: Helper macro for consistent message output
gcode:
    ; --- PARAMETERS ---
    {% set param = namespace(
        msg=params.MSG
    ) %}

    SET_DISPLAY_TEXT MSG="{param.msg}" ; Output to display
    { action_respond_info(param.msg) } ; Output to console via native Jinja function

[gcode_macro _RESET_STATE]
description: Clears all transformations and machine states
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        max_vel=printer.configfile.settings.printer.max_velocity|float,
        max_accel=printer.configfile.settings.printer.max_accel|float,
        max_scv=printer.configfile.settings.printer.square_corner_velocity|float
    ) %}

    M220 S100                                                                                            ; Reset feedrate to 100 percent
    M221 S100                                                                                            ; Reset flowrate to 100 percent
    BED_MESH_CLEAR                                                                                       ; Clear active bed mesh
    CLEAR_PAUSE                                                                                          ; Clear any active pause state
    SET_SKEW CLEAR=1                                                                                     ; Clear skew correction profiles
    SET_GCODE_OFFSET Z=0                                                                                 ; Clear Cartographer touch offset
    SET_VELOCITY_LIMIT VELOCITY={ref.max_vel} ACCEL={ref.max_accel} SQUARE_CORNER_VELOCITY={ref.max_scv} ; Restore absolute hardware limits

[gcode_macro _TOGGLE_FILAMENT_SENSORS]
description: Helper macro to globally toggle filament sensors
gcode:
    ; --- PARAMETERS ---
    {% set param = namespace(
        state=params.ENABLE|default(1)|int
    ) %}

    SET_FILAMENT_SENSOR SENSOR=switch_sensor ENABLE={param.state}  ; Toggle switch sensor
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE={param.state} ; Toggle encoder sensor

################################################################################
# Event Hooks (Mainsail)
################################################################################
[gcode_macro _HOOK_ON_PAUSE]
description: Hook executed when print is paused
gcode:
    _STATUS_BUSY
    _NOTIFY MSG="System: Print paused"

[gcode_macro _HOOK_ON_RESUME]
description: Hook executed when print is resumed
gcode:
    _STATUS_PRINTING
    _NOTIFY MSG="System: Print resumed"

[gcode_macro _HOOK_ON_CANCEL]
description: Hook executed when print is canceled
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        nevermore_speed=printer['fan_generic nevermore'].speed|default(0.0)
    ) %}

    _STATUS_READY
    _TOGGLE_FILAMENT_SENSORS ENABLE=1                                    ; Enable runout sensors

    {% if ref.nevermore_speed > 0.0 %}                                   ; Check if filter is active
        _NOTIFY MSG="System: Print canceled. Filtering VOCs for 10 min."
        UPDATE_DELAYED_GCODE ID=STOP_NEVERMORE DURATION=600              ; Schedule Nevermore shutdown
    {% else %}                                                           ; Fallback if filter is off
        _NOTIFY MSG="System: Print canceled."
    {% endif %}

################################################################################
# PID Tuning
################################################################################
[gcode_macro PID_BED]
description: PID tuning for bed heater
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        vars=printer["gcode_macro _MY_VARS"],
        th=printer.toolhead,
        max_xy_vel=printer.configfile.settings.printer.max_velocity|float,
        max_z_vel=printer.configfile.settings.printer.max_z_velocity|float
    ) %}

    ; --- PARAMETERS ---
    {% set param = namespace(
        temp=params.TEMP|default(100.0)|float
    ) %}

    ; --- KINEMATICS & SPEEDS ---
    {% set speed = namespace(
        travel_xy=(ref.max_xy_vel * ref.vars.travel_factor_xy * 60)|int,
        travel_z=(ref.max_z_vel * ref.vars.travel_factor_z * 60)|int
    ) %}

    ; --- POSITIONS ---
    {% set pos = namespace(
        center_x=ref.th.axis_maximum.x|float / 2.0,
        center_y=ref.th.axis_maximum.y|float / 2.0,
        z_hop=ref.vars.z_hop|float
    ) %}

    _NOTIFY MSG="System: Starting bed PID tuning ({param.temp}C)..."
    CONDITIONAL_HOME                                      ; Execute conditional homing
    G90                                                   ; Set absolute positioning
    G0 Z{pos.z_hop} F{speed.travel_z}                     ; Lift Z safely
    G0 X{pos.center_x} Y{pos.center_y} F{speed.travel_xy} ; Move to bed center
    PID_CALIBRATE HEATER=heater_bed TARGET={param.temp}   ; Execute native command
    CENTER                                                ; Park toolhead
    _NOTIFY MSG="System: Bed PID tuning complete. Save config."

[gcode_macro PID_HOTEND]
description: PID tuning for extruder heater
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        vars=printer["gcode_macro _MY_VARS"],
        th=printer.toolhead,
        max_xy_vel=printer.configfile.settings.printer.max_velocity|float,
        max_z_vel=printer.configfile.settings.printer.max_z_velocity|float
    ) %}

    ; --- PARAMETERS ---
    {% set param = namespace(
        temp=params.TEMP|default(245.0)|float
    ) %}

    ; --- KINEMATICS & SPEEDS ---
    {% set speed = namespace(
        travel_xy=(ref.max_xy_vel * ref.vars.travel_factor_xy * 60)|int,
        travel_z=(ref.max_z_vel * ref.vars.travel_factor_z * 60)|int
    ) %}

    ; --- POSITIONS ---
    {% set pos = namespace(
        center_x=ref.th.axis_maximum.x|float / 2.0,
        center_y=ref.th.axis_maximum.y|float / 2.0,
        z_target=5.0
    ) %}

    _NOTIFY MSG="System: Starting extruder PID tuning ({param.temp}C)..."
    CONDITIONAL_HOME                                      ; Execute conditional homing
    G90                                                   ; Set absolute positioning
    G0 Z{pos.z_target} F{speed.travel_z}                  ; Move strictly 5mm above bed
    G0 X{pos.center_x} Y{pos.center_y} F{speed.travel_xy} ; Move to bed center
    M106 S64                                              ; Set part cooling fan to 25 percent
    PID_CALIBRATE HEATER=extruder TARGET={param.temp}     ; Execute native command
    M107                                                  ; Turn off part cooling fan
    CENTER                                                ; Park toolhead
    _NOTIFY MSG="System: Extruder PID tuning complete. Save config."

################################################################################
# SAVE CONFIG Block
################################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 34.577
#*# pid_ki = 12.807
#*# pid_kd = 23.339
