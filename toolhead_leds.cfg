################################################################################
# Toolhead LED Configuration
################################################################################
# Description:
#   LED status macros and logic for the toolhead (Logo + Nozzle).
#
# Instructions:
#   1. Add [include toolhead_leds.cfg] to printer.cfg.
#   2. Define [neopixel toolhead_leds] in printer.cfg.
#   3. Use the _STATUS_... macros inside your main print macros.
################################################################################

################################################################################
# Variables & Color Definitions
################################################################################
[gcode_macro _LED_VARS]
variable_logo_led_name   : "toolhead_leds"  ; Name of the LED chain for the logo
variable_logo_idx        : "1"              ; Index of the logo LED(s)
variable_nozzle_led_name : "toolhead_leds"  ; Name of the LED chain for the nozzle
variable_nozzle_idx      : "2,3"            ; Index of the nozzle LED(s)

variable_colors: {
    'logo': {
        'busy'         : {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0}, ; Red
        'cleaning'     : {'r': 0.0, 'g': 0.0, 'b': 1.0, 'w': 0.0}, ; Blue
        'heating'      : {'r': 1.0, 'g': 0.5, 'b': 0.0, 'w': 0.0}, ; Orange
        'homing'       : {'r': 0.0, 'g': 1.0, 'b': 1.0, 'w': 0.0}, ; Cyan
        'leveling'     : {'r': 1.0, 'g': 1.0, 'b': 0.0, 'w': 0.0}, ; Yellow
        'meshing'      : {'r': 0.0, 'g': 1.0, 'b': 0.0, 'w': 0.0}, ; Green
        'off'          : {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0}, ; Off
        'printing'     : {'r': 1.0, 'g': 1.0, 'b': 1.0, 'w': 0.0}, ; White (Full)
        'standby'      : {'r': 0.1, 'g': 0.1, 'b': 0.1, 'w': 0.0}, ; Dim White
    },
    'nozzle': {
        'busy'         : {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0}, ; Red
        'cleaning'     : {'r': 0.0, 'g': 0.0, 'b': 1.0, 'w': 0.0}, ; Blue
        'heating'      : {'r': 1.0, 'g': 0.5, 'b': 0.0, 'w': 0.0}, ; Orange
        'homing'       : {'r': 0.0, 'g': 1.0, 'b': 1.0, 'w': 0.0}, ; Cyan
        'leveling'     : {'r': 1.0, 'g': 1.0, 'b': 0.0, 'w': 0.0}, ; Yellow
        'meshing'      : {'r': 0.0, 'g': 1.0, 'b': 0.0, 'w': 0.0}, ; Green
        'off'          : {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0}, ; Off
        'printing'     : {'r': 1.0, 'g': 1.0, 'b': 1.0, 'w': 0.0}, ; White (Full)
        'standby'      : {'r': 0.1, 'g': 0.1, 'b': 0.1, 'w': 0.0}, ; Dim White
    }
  }
gcode:
    ; Mandatory G-Code section for variable macros

################################################################################
# Internal Helper Macros
################################################################################
[gcode_macro _SET_LEDS]
gcode:
    ; --- PARAMETERS ---
    {% set param = namespace(
        red=params.RED|default(0)|float,
        green=params.GREEN|default(0)|float,
        blue=params.BLUE|default(0)|float,
        white=params.WHITE|default(0)|float,
        led=params.LED|string,
        idx=(params.IDX|string).split(','),
        transmit_last=params.TRANSMIT|default(1)
    ) %}

    {% for led_index in param.idx %}                                                                                                            ; Loop over all LED indices
        {% set transmit = param.transmit_last if loop.last else 0 %}                                                                            ; Calculate transmit state
        SET_LED LED={param.led} RED={param.red} GREEN={param.green} BLUE={param.blue} WHITE={param.white} INDEX={led_index} TRANSMIT={transmit} ; Set physical LED state
    {% endfor %}                                                                                                                                ; End loop

[gcode_macro _SET_LEDS_BY_NAME]
gcode:
    ; --- REFERENCES ---
    {% set ref = namespace(
        vars=printer["gcode_macro _LED_VARS"]
    ) %}

    ; --- PARAMETERS ---
    {% set param = namespace(
        leds_name=params.LEDS,
        color_name=params.COLOR,
        transmit=params.TRANSMIT|default(1)
    ) %}

    ; --- STATE & LOGIC ---
    {% set logic = namespace(
        color=ref.vars.colors[param.leds_name][param.color_name],
        led=ref.vars[param.leds_name ~ "_led_name"],
        idx=ref.vars[param.leds_name ~ "_idx"]
    ) %}

    _SET_LEDS LED={logic.led} RED={logic.color.r} GREEN={logic.color.g} BLUE={logic.color.b} WHITE={logic.color.w} IDX="{logic.idx}" TRANSMIT={param.transmit} ; Call base setter

################################################################################
# Hidden Control & Status Macros
################################################################################
[gcode_macro _SET_LOGO_LEDS_OFF]
gcode:
    ; --- PARAMETERS ---
    {% set param = namespace(
        transmit=params.TRANSMIT|default(1)
    ) %}

    _SET_LEDS_BY_NAME LEDS="logo" COLOR="off" TRANSMIT={param.transmit} ; Call base setter

[gcode_macro _STATUS_OFF]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="off" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="off" TRANSMIT=1

[gcode_macro _STATUS_READY]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="standby" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="standby" TRANSMIT=1

[gcode_macro _STATUS_BUSY]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="busy" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="busy" TRANSMIT=1

[gcode_macro _STATUS_HEATING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="heating" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="heating" TRANSMIT=1

[gcode_macro _STATUS_LEVELING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="leveling" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="leveling" TRANSMIT=1

[gcode_macro _STATUS_HOMING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="homing" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="homing" TRANSMIT=1

[gcode_macro _STATUS_CLEANING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="cleaning" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="cleaning" TRANSMIT=1

[gcode_macro _STATUS_MESHING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="meshing" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="meshing" TRANSMIT=1

[gcode_macro _STATUS_PRINTING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="printing" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="printing" TRANSMIT=1

################################################################################
# Boot Initialization
################################################################################
[delayed_gcode SET_LEDS_ON_BOOT]
initial_duration: 1.0
gcode:
    _STATUS_READY
