################################################################################
# Toolhead LED Configuration
################################################################################
# Description:
#   LED status macros and logic for the toolhead (Logo + Nozzle).
#
# Instructions:
#   1. Add [include toolhead_leds.cfg] to printer.cfg.
#   2. Define [neopixel toolhead_leds] in printer.cfg.
#   3. Use the _STATUS_... macros inside your main print macros.
################################################################################

################################################################################
# Variables & Color Definitions
################################################################################
[gcode_macro _LED_VARS]
variable_logo_led_name   : "toolhead_leds"  ; Name of the LED chain for the logo
variable_logo_idx        : "1"              ; Index of the logo LED(s)
variable_nozzle_led_name : "toolhead_leds"  ; Name of the LED chain for the nozzle
variable_nozzle_idx      : "2,3"            ; Index of the nozzle LED(s)

variable_colors: {
    'logo': {
        'busy'         : {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0}, ; Red
        'cleaning'     : {'r': 0.0, 'g': 0.0, 'b': 1.0, 'w': 0.0}, ; Blue
        'heating'      : {'r': 1.0, 'g': 0.5, 'b': 0.0, 'w': 0.0}, ; Orange
        'homing'       : {'r': 0.0, 'g': 1.0, 'b': 1.0, 'w': 0.0}, ; Cyan
        'leveling'     : {'r': 1.0, 'g': 1.0, 'b': 0.0, 'w': 0.0}, ; Yellow
        'meshing'      : {'r': 0.0, 'g': 1.0, 'b': 0.0, 'w': 0.0}, ; Green
        'off'          : {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0}, ; Off
        'printing'     : {'r': 1.0, 'g': 1.0, 'b': 1.0, 'w': 0.0}, ; White (Full)
        'standby'      : {'r': 0.1, 'g': 0.1, 'b': 0.1, 'w': 0.0}, ; Dim White
    },
    'nozzle': {
        'busy'         : {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0}, ; Red
        'cleaning'     : {'r': 0.0, 'g': 0.0, 'b': 1.0, 'w': 0.0}, ; Blue
        'heating'      : {'r': 1.0, 'g': 0.5, 'b': 0.0, 'w': 0.0}, ; Orange
        'homing'       : {'r': 0.0, 'g': 1.0, 'b': 1.0, 'w': 0.0}, ; Cyan
        'leveling'     : {'r': 1.0, 'g': 1.0, 'b': 0.0, 'w': 0.0}, ; Yellow
        'meshing'      : {'r': 0.0, 'g': 1.0, 'b': 0.0, 'w': 0.0}, ; Green
        'off'          : {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0}, ; Off
        'printing'     : {'r': 1.0, 'g': 1.0, 'b': 1.0, 'w': 0.0}, ; White (Full)
        'standby'      : {'r': 0.1, 'g': 0.1, 'b': 0.1, 'w': 0.0}, ; Dim White
    }
  }
gcode:
    ; Mandatory G-Code section for variable macros

################################################################################
# Internal Helper Macros
################################################################################
[gcode_macro _SET_LEDS]
gcode:
    {% set red   = params.RED|default(0)|float %}
    {% set green = params.GREEN|default(0)|float %}
    {% set blue  = params.BLUE|default(0)|float %}
    {% set white = params.WHITE|default(0)|float %}
    {% set led   = params.LED|string %}
    {% set idx   = (params.IDX|string).split(',') %}
    {% set transmit_last = params.TRANSMIT|default(1) %}

    {% for led_index in idx %}
        {% set transmit = transmit_last if loop.last else 0 %}
        SET_LED LED={led} RED={red} GREEN={green} BLUE={blue} WHITE={white} INDEX={led_index} TRANSMIT={transmit}
    {% endfor %}

[gcode_macro _SET_LEDS_BY_NAME]
gcode:
    {% set leds_name  = params.LEDS %}
    {% set color_name = params.COLOR %}
    {% set color      = printer["gcode_macro _LED_VARS"].colors[leds_name][color_name] %}
    {% set led        = printer["gcode_macro _LED_VARS"][leds_name + "_led_name"] %}
    {% set idx        = printer["gcode_macro _LED_VARS"][leds_name + "_idx"] %}
    {% set transmit   = params.TRANSMIT|default(1) %}

    _SET_LEDS LED={led} RED={color.r} GREEN={color.g} BLUE={color.b} WHITE={color.w} IDX="{idx}" TRANSMIT={transmit}

################################################################################
# Hidden Control & Status Macros
################################################################################
[gcode_macro _SET_LOGO_LEDS_OFF]
gcode:
    {% set transmit = params.TRANSMIT|default(1) %}
    _SET_LEDS_BY_NAME LEDS="logo" COLOR="off" TRANSMIT={transmit}

[gcode_macro _STATUS_OFF]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="off" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="off" TRANSMIT=1

[gcode_macro _STATUS_READY]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="standby" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="standby" TRANSMIT=1

[gcode_macro _STATUS_BUSY]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="busy"    TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="busy"    TRANSMIT=1

[gcode_macro _STATUS_HEATING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="heating" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="heating" TRANSMIT=1

[gcode_macro _STATUS_LEVELING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="leveling" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="leveling" TRANSMIT=1

[gcode_macro _STATUS_HOMING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="homing"  TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="homing"  TRANSMIT=1

[gcode_macro _STATUS_CLEANING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="cleaning" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="cleaning" TRANSMIT=1

[gcode_macro _STATUS_MESHING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="meshing" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="meshing" TRANSMIT=1

[gcode_macro _STATUS_PRINTING]
gcode:
    _SET_LEDS_BY_NAME LEDS="logo"   COLOR="printing" TRANSMIT=0
    _SET_LEDS_BY_NAME LEDS="nozzle" COLOR="printing" TRANSMIT=1

################################################################################
# Boot Initialization
################################################################################
[delayed_gcode SET_LEDS_ON_BOOT]
initial_duration: 1.0
gcode:
    _STATUS_READY
